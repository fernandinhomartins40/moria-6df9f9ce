// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum CustomerLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum OfferType {
  DIA
  SEMANA
  MES
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PRODUCTION
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderSource {
  WEB
  APP
  PHONE
}

enum OrderItemType {
  PRODUCT
  SERVICE
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

enum AdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum QuoteStatus {
  PENDING
  ANALYZING
  QUOTED
  APPROVED
  REJECTED
}

enum NotificationType {
  NEW_QUOTE_REQUEST
  QUOTE_RESPONDED
  QUOTE_APPROVED
  QUOTE_REJECTED
  ORDER_STATUS_UPDATED
  ORDER_CREATED
}

enum NotificationRecipientType {
  ADMIN
  CUSTOMER
}

// ============================================================================
// MODELS - FASE 1
// ============================================================================

model Admin {
  id          String      @id @default(uuid())
  email       String      @unique
  password    String
  name        String
  role        AdminRole   @default(STAFF)
  status      AdminStatus @default(ACTIVE)
  permissions Json?       // Array de permissões customizadas

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  lastLoginAt DateTime?

  // Relations
  assignedRevisions Revision[]
  auditLogs        AuditLog[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("admins")
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  action     String   // CREATE, UPDATE, DELETE, ASSIGN, etc
  resource   String   // Revision, Order, Product, etc
  resourceId String?
  changes    Json?    // Antes/depois
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Customer {
  id          String         @id @default(uuid())
  email       String         @unique
  password    String
  name        String
  phone       String
  cpf         String?        @unique
  birthDate   DateTime?
  status      CustomerStatus @default(ACTIVE)
  level       CustomerLevel  @default(BRONZE)
  totalOrders Int            @default(0)
  totalSpent  Decimal        @default(0) @db.Decimal(10, 2)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  addresses Address[]
  orders    Order[]
  favorites Favorite[]
  vehicles  CustomerVehicle[]
  revisions Revision[]

  @@index([email])
  @@index([cpf])
  @@index([status])
  @@index([level])
  @@index([createdAt])
  @@map("customers")
}

model Address {
  id           String      @id @default(uuid())
  customerId   String
  type         AddressType @default(HOME)
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String      @db.Char(2)
  zipCode      String      @db.Char(8)
  isDefault    Boolean     @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([zipCode])
  @@map("addresses")
}

// ============================================================================
// MODELS - FASE 2: PRODUTOS, SERVIÇOS E VEÍCULOS
// ============================================================================

// Produtos
model Product {
  id             String        @id @default(uuid())
  name           String
  description    String        @db.Text
  category       String
  subcategory    String?
  sku            String        @unique
  supplier       String
  costPrice      Decimal       @db.Decimal(10, 2)
  salePrice      Decimal       @db.Decimal(10, 2)
  promoPrice     Decimal?      @db.Decimal(10, 2)
  stock          Int           @default(0)
  minStock       Int           @default(5)
  images         Json // Array de URLs
  specifications Json? // Especificações técnicas estruturadas
  status         ProductStatus @default(ACTIVE)

  // Ofertas (Dia/Semana/Mês)
  offerType      OfferType?
  offerStartDate DateTime?
  offerEndDate   DateTime?
  offerBadge     String? // Ex: "LIMITADO", "QUEIMA DE ESTOQUE"

  // SEO
  slug            String  @unique
  metaDescription String?
  metaKeywords    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicleCompatibility ProductVehicleCompatibility[]

  @@index([category])
  @@index([status])
  @@index([sku])
  @@index([slug])
  @@index([offerType, offerStartDate, offerEndDate])
  @@map("products")
}

// Serviços
model Service {
  id             String        @id @default(uuid())
  name           String
  description    String        @db.Text
  category       String
  estimatedTime  String // Ex: "2 horas"
  basePrice      Decimal?      @db.Decimal(10, 2)
  specifications Json?
  status         ServiceStatus @default(ACTIVE)

  // SEO
  slug            String  @unique
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([slug])
  @@map("services")
}

// Marcas de Veículos
model VehicleMake {
  id      String  @id @default(uuid())
  name    String  @unique
  country String
  logo    String?
  active  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  models VehicleModel[]

  @@index([name])
  @@map("vehicle_makes")
}

// Modelos de Veículos
model VehicleModel {
  id        String  @id @default(uuid())
  makeId    String
  name      String
  segment   String // mini, hatch, sedan, suv, etc.
  bodyType  String // 2-door, 4-door, etc.
  fuelTypes Json // Array de tipos de combustível
  active    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  make     VehicleMake      @relation(fields: [makeId], references: [id], onDelete: Cascade)
  variants VehicleVariant[]

  @@index([makeId])
  @@index([segment])
  @@map("vehicle_models")
}

// Variantes de Veículos
model VehicleVariant {
  id             String  @id @default(uuid())
  modelId        String
  name           String
  engineInfo     Json // Informações do motor
  transmission   String
  yearStart      Int
  yearEnd        Int?
  specifications Json // Especificações técnicas
  active         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  model VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId])
  @@index([yearStart])
  @@index([yearEnd])
  @@map("vehicle_variants")
}

// Compatibilidade Produto-Veículo
model ProductVehicleCompatibility {
  id                String  @id @default(uuid())
  productId         String
  makeId            String?
  modelId           String?
  variantId         String?
  yearStart         Int?
  yearEnd           Int?
  compatibilityData Json // Regras detalhadas de compatibilidade
  verified          Boolean @default(false)
  notes             String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([makeId])
  @@index([modelId])
  @@map("product_vehicle_compatibility")
}

// ============================================================================
// MODELS - FASE 3: PEDIDOS, PROMOÇÕES E CUPONS
// ============================================================================

// Pedidos
model Order {
  id          String      @id @default(uuid())
  customerId  String
  addressId   String
  status      OrderStatus @default(PENDING)
  source      OrderSource @default(WEB)
  hasProducts Boolean     @default(false)
  hasServices Boolean     @default(false)

  // Campos de Orçamento (Quote)
  quoteStatus     QuoteStatus? // Status do orçamento se hasServices = true
  quotedAt        DateTime?    // Quando o orçamento foi enviado ao cliente
  quoteApprovedAt DateTime?    // Quando o cliente aprovou o orçamento
  quoteNotes      String?      @db.Text // Observações do orçamento

  // Valores
  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Pagamento e Entrega
  paymentMethod     String
  trackingCode      String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?

  // Cupom/Promoção
  couponCode        String?
  appliedPromotions Json? // Array de IDs de promoções aplicadas

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  // Relations
  customer Customer    @relation(fields: [customerId], references: [id])
  items    OrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([quoteStatus])
  @@index([createdAt])
  @@map("orders")
}

// Itens do Pedido
model OrderItem {
  id        String        @id @default(uuid())
  orderId   String
  productId String?
  serviceId String?
  type      OrderItemType
  name      String
  price     Decimal       @default(0) @db.Decimal(10, 2)
  quantity  Int
  subtotal  Decimal       @default(0) @db.Decimal(10, 2)

  // Campos de Cotação (para serviços)
  priceQuoted Boolean   @default(false) // Se o preço foi cotado
  quotedPrice Decimal?  @db.Decimal(10, 2) // Preço cotado pelo lojista
  quotedAt    DateTime? // Quando foi cotado

  createdAt DateTime @default(now())

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@index([serviceId])
  @@map("order_items")
}

// Promoções
model Promotion {
  id               String  @id @default(uuid())
  name             String
  description      String  @db.Text
  shortDescription String?
  bannerImage      String?
  badgeText        String?

  // Configuração
  type    String // PERCENTAGE, FIXED, etc.
  target  String // ALL_PRODUCTS, SPECIFIC_PRODUCTS, etc.
  trigger String // CART_VALUE, ITEM_QUANTITY, etc.

  // Segmentação
  customerSegments       Json // Array de segmentos
  geographicRestrictions Json?
  deviceTypes            Json?

  // Regras
  rules Json // Array de regras complexas
  tiers Json? // Descontos escalonados

  // Produtos alvo
  targetProductIds  Json?
  targetCategories  Json?
  targetBrands      Json?
  targetPriceRange  Json?
  excludeProductIds Json?
  excludeCategories Json?

  // Recompensas
  rewards Json // Estrutura de recompensas

  // Agendamento
  schedule  Json // Configuração de agenda
  startDate DateTime
  endDate   DateTime

  // Limitações
  usageLimit            Int?
  usageLimitPerCustomer Int?
  usedCount             Int  @default(0)

  // Combinação
  canCombineWithOthers Boolean @default(false)
  excludePromotionIds  Json?
  priority             Int     @default(0)

  // Código
  code      String? @unique
  autoApply Boolean @default(false)

  // Estados
  isActive Boolean @default(true)
  isDraft  Boolean @default(false)

  // Analytics
  analytics Json?

  // Metadados
  createdBy      String
  lastModifiedBy String?
  approvedBy     String?
  approvedAt     DateTime?
  tags           Json?
  notes          String?   @db.Text

  // Configurações avançadas
  customLogic String? @db.Text
  webhookUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("promotions")
}

// Cupons
model Coupon {
  id            String   @id @default(uuid())
  code          String   @unique
  description   String
  discountType  String // PERCENTAGE, FIXED
  discountValue Decimal  @db.Decimal(10, 2)
  minValue      Decimal? @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)
  expiresAt     DateTime
  usageLimit    Int?
  usedCount     Int      @default(0)
  isActive      Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([expiresAt])
  @@index([isActive])
  @@map("coupons")
}

// Favoritos
model Favorite {
  id         String @id @default(uuid())
  customerId String
  productId  String

  createdAt DateTime @default(now())

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
  @@index([customerId])
  @@index([productId])
  @@map("favorites")
}

// ============================================================================
// MODELS - FASE 4: REVISÕES VEICULARES
// ============================================================================

enum RevisionStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ChecklistItemStatus {
  NOT_CHECKED
  OK
  ATTENTION
  CRITICAL
  NOT_APPLICABLE
}

// Veículos dos Clientes (para Revisões)
model CustomerVehicle {
  id            String  @id @default(uuid())
  customerId    String
  brand         String
  model         String
  year          Int
  plate         String  @unique
  chassisNumber String?
  color         String?
  mileage       Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  revisions Revision[]

  @@index([customerId])
  @@index([plate])
  @@map("customer_vehicles")
}

// Categorias do Checklist
model ChecklistCategory {
  id          String  @id @default(uuid())
  name        String
  description String?
  icon        String?
  isDefault   Boolean @default(false)
  isEnabled   Boolean @default(true)
  order       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items ChecklistItem[]

  @@index([order])
  @@map("checklist_categories")
}

// Itens do Checklist
model ChecklistItem {
  id          String  @id @default(uuid())
  categoryId  String
  name        String
  description String?
  isDefault   Boolean @default(false)
  isEnabled   Boolean @default(true)
  order       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category ChecklistCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([order])
  @@map("checklist_items")
}

// Revisões
model Revision {
  id              String         @id @default(uuid())
  customerId      String
  vehicleId       String
  date            DateTime
  mileage         Int?
  status          RevisionStatus @default(DRAFT)
  checklistItems  Json // Array de itens verificados
  generalNotes    String?        @db.Text
  recommendations String?        @db.Text

  // Mecânico responsável
  assignedMechanicId String?
  mechanicName       String? // Cache do nome para performance
  mechanicNotes      String?  @db.Text
  assignedAt         DateTime?
  transferHistory    Json? // Array de histórico de transferências

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  customer         Customer        @relation(fields: [customerId], references: [id])
  vehicle          CustomerVehicle @relation(fields: [vehicleId], references: [id])
  assignedMechanic Admin?          @relation(fields: [assignedMechanicId], references: [id])

  @@index([customerId])
  @@index([vehicleId])
  @@index([status])
  @@index([date])
  @@index([assignedMechanicId])
  @@map("revisions")
}

// Notificações
model Notification {
  id            String                    @id @default(uuid())
  recipientType NotificationRecipientType
  recipientId   String // ID do Admin ou Customer
  type          NotificationType
  title         String
  message       String                    @db.Text
  data          Json? // Dados contextuais (orderId, quoteId, etc)
  read          Boolean                   @default(false)
  readAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, recipientType, read])
  @@index([createdAt])
  @@map("notifications")
}
