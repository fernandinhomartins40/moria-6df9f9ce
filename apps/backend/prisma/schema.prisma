// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum CustomerLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderSource {
  WEB
  APP
  PHONE
}

enum OrderItemType {
  PRODUCT
  SERVICE
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

enum AdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================================================
// MODELS - FASE 1
// ============================================================================

model Admin {
  id          String      @id @default(uuid())
  email       String      @unique
  password    String
  name        String
  role        AdminRole   @default(STAFF)
  status      AdminStatus @default(ACTIVE)
  permissions Json?       // Array de permissões customizadas

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("admins")
}

model Customer {
  id                     String         @id @default(uuid())
  email                  String         @unique
  password               String
  name                   String
  phone                  String
  cpf                    String?        @unique
  birthDate              DateTime?
  status                 CustomerStatus @default(ACTIVE)
  level                  CustomerLevel  @default(BRONZE)
  totalOrders            Int            @default(0)
  totalSpent             Decimal        @default(0) @db.Decimal(10, 2)
  hasProvisionalPassword Boolean        @default(false) // Indica se precisa trocar senha

  // Programa de Fidelidade
  loyaltyPoints          Int            @default(0) // Pontos atuais disponíveis
  totalPointsEarned      Int            @default(0) // Total de pontos ganhos (histórico)
  totalPointsRedeemed    Int            @default(0) // Total de pontos resgatados (histórico)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  addresses           Address[]
  orders              Order[]
  favorites           Favorite[]
  vehicles            CustomerVehicle[]
  revisions           Revision[]
  pointTransactions   PointTransaction[]
  redeemedRewards     RedeemedReward[]

  @@index([email])
  @@index([cpf])
  @@index([status])
  @@index([level])
  @@index([phone])
  @@index([createdAt])
  @@index([loyaltyPoints])
  @@map("customers")
}

model Address {
  id           String      @id @default(uuid())
  customerId   String
  type         AddressType @default(HOME)
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String      @db.Char(2)
  zipCode      String      @db.Char(8)
  isDefault    Boolean     @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([zipCode])
  @@map("addresses")
}

// ============================================================================
// MODELS - FASE 2: PRODUTOS, SERVIÇOS E VEÍCULOS
// ============================================================================

// Produtos
model Product {
  id             String        @id @default(uuid())
  name           String
  description    String        @db.Text
  category       String
  subcategory    String?
  sku            String        @unique
  supplier       String
  costPrice      Decimal       @db.Decimal(10, 2)
  salePrice      Decimal       @db.Decimal(10, 2)
  promoPrice     Decimal?      @db.Decimal(10, 2)
  stock          Int           @default(0)
  minStock       Int           @default(5)
  images         Json // Array de URLs
  specifications Json? // Especificações técnicas estruturadas
  status         ProductStatus @default(ACTIVE)

  // SEO
  slug            String  @unique
  metaDescription String?
  metaKeywords    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicleCompatibility ProductVehicleCompatibility[]
  favorites            Favorite[]

  @@index([category])
  @@index([status])
  @@index([sku])
  @@index([slug])
  @@map("products")
}

// Serviços
model Service {
  id             String        @id @default(uuid())
  name           String
  description    String        @db.Text
  category       String
  estimatedTime  String // Ex: "2 horas"
  basePrice      Decimal?      @db.Decimal(10, 2)
  specifications Json?
  status         ServiceStatus @default(ACTIVE)

  // SEO
  slug            String  @unique
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([slug])
  @@map("services")
}

// Marcas de Veículos
model VehicleMake {
  id      String  @id @default(uuid())
  name    String  @unique
  country String
  logo    String?
  active  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  models VehicleModel[]

  @@index([name])
  @@map("vehicle_makes")
}

// Modelos de Veículos
model VehicleModel {
  id        String  @id @default(uuid())
  makeId    String
  name      String
  segment   String // mini, hatch, sedan, suv, etc.
  bodyType  String // 2-door, 4-door, etc.
  fuelTypes Json // Array de tipos de combustível
  active    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  make     VehicleMake      @relation(fields: [makeId], references: [id], onDelete: Cascade)
  variants VehicleVariant[]

  @@index([makeId])
  @@index([segment])
  @@map("vehicle_models")
}

// Variantes de Veículos
model VehicleVariant {
  id             String  @id @default(uuid())
  modelId        String
  name           String
  engineInfo     Json // Informações do motor
  transmission   String
  yearStart      Int
  yearEnd        Int?
  specifications Json // Especificações técnicas
  active         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  model VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId])
  @@index([yearStart])
  @@index([yearEnd])
  @@map("vehicle_variants")
}

// Compatibilidade Produto-Veículo
model ProductVehicleCompatibility {
  id                String  @id @default(uuid())
  productId         String
  makeId            String?
  modelId           String?
  variantId         String?
  yearStart         Int?
  yearEnd           Int?
  compatibilityData Json // Regras detalhadas de compatibilidade
  verified          Boolean @default(false)
  notes             String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([makeId])
  @@index([modelId])
  @@map("product_vehicle_compatibility")
}

// ============================================================================
// MODELS - FASE 3: PEDIDOS, PROMOÇÕES E CUPONS
// ============================================================================

// Pedidos
model Order {
  id          String      @id @default(uuid())
  customerId  String
  addressId   String
  status      OrderStatus @default(PENDING)
  source      OrderSource @default(WEB)
  hasProducts Boolean     @default(false)
  hasServices Boolean     @default(false)

  // Valores
  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Pagamento e Entrega
  paymentMethod     String
  trackingCode      String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?

  // Cupom/Promoção
  couponCode        String?
  appliedPromotions Json? // Array de IDs de promoções aplicadas

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  // Relations
  customer Customer       @relation(fields: [customerId], references: [id])
  items    OrderItem[]
  tracking OrderTracking?

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// Itens do Pedido
model OrderItem {
  id        String        @id @default(uuid())
  orderId   String
  productId String?
  serviceId String?
  type      OrderItemType
  name      String
  price     Decimal       @db.Decimal(10, 2)
  quantity  Int
  subtotal  Decimal       @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@index([serviceId])
  @@map("order_items")
}

// Promoções
model Promotion {
  id               String  @id @default(uuid())
  name             String
  description      String  @db.Text
  shortDescription String?
  bannerImage      String?
  badgeText        String?

  // Configuração
  type    String // PERCENTAGE, FIXED, etc.
  target  String // ALL_PRODUCTS, SPECIFIC_PRODUCTS, etc.
  trigger String // CART_VALUE, ITEM_QUANTITY, etc.

  // Segmentação
  customerSegments       Json // Array de segmentos
  geographicRestrictions Json?
  deviceTypes            Json?

  // Regras
  rules Json // Array de regras complexas
  tiers Json? // Descontos escalonados

  // Produtos alvo
  targetProductIds  Json?
  targetCategories  Json?
  targetBrands      Json?
  targetPriceRange  Json?
  excludeProductIds Json?
  excludeCategories Json?

  // Recompensas
  rewards Json // Estrutura de recompensas

  // Agendamento
  schedule  Json // Configuração de agenda
  startDate DateTime
  endDate   DateTime

  // Limitações
  usageLimit            Int?
  usageLimitPerCustomer Int?
  usedCount             Int  @default(0)

  // Combinação
  canCombineWithOthers Boolean @default(false)
  excludePromotionIds  Json?
  priority             Int     @default(0)

  // Código
  code      String? @unique
  autoApply Boolean @default(false)

  // Estados
  isActive Boolean @default(true)
  isDraft  Boolean @default(false)

  // Analytics
  analytics Json?

  // Metadados
  createdBy      String
  lastModifiedBy String?
  approvedBy     String?
  approvedAt     DateTime?
  tags           Json?
  notes          String?   @db.Text

  // Configurações avançadas
  customLogic String? @db.Text
  webhookUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("promotions")
}

// Cupons
model Coupon {
  id            String   @id @default(uuid())
  code          String   @unique
  description   String
  discountType  String // PERCENTAGE, FIXED
  discountValue Decimal  @db.Decimal(10, 2)
  minValue      Decimal? @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)
  expiresAt     DateTime
  usageLimit    Int?
  usedCount     Int      @default(0)
  isActive      Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([expiresAt])
  @@index([isActive])
  @@map("coupons")
}

// Favoritos
model Favorite {
  id         String @id @default(uuid())
  customerId String
  productId  String

  createdAt DateTime @default(now())

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
  @@index([customerId])
  @@index([productId])
  @@map("favorites")
}

// ============================================================================
// MODELS - FASE 4: REVISÕES VEICULARES
// ============================================================================

enum RevisionStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ChecklistItemStatus {
  NOT_CHECKED
  OK
  ATTENTION
  CRITICAL
  NOT_APPLICABLE
}

// ============================================================================
// MODELS - FASE 5: PROGRAMA DE FIDELIDADE
// ============================================================================

enum PointTransactionType {
  EARN_PURCHASE      // Ganho por compra
  EARN_REVISION      // Ganho por revisão
  EARN_REFERRAL      // Ganho por indicação
  EARN_BIRTHDAY      // Ganho de aniversário
  EARN_MANUAL        // Adição manual pelo admin
  REDEEM_REWARD      // Resgate de recompensa
  REDEEM_DISCOUNT    // Resgate de desconto
  EXPIRE             // Expiração de pontos
  ADJUST_MANUAL      // Ajuste manual (positivo ou negativo)
  CANCELLED_ORDER    // Estorno por cancelamento de pedido
}

enum RewardType {
  DISCOUNT_PERCENTAGE // Desconto percentual
  DISCOUNT_FIXED      // Desconto fixo em reais
  FREE_PRODUCT        // Produto grátis
  FREE_SERVICE        // Serviço grátis
  FREE_SHIPPING       // Frete grátis
  SPECIAL_OFFER       // Oferta especial
}

enum RewardStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

// Veículos dos Clientes (para Revisões)
model CustomerVehicle {
  id            String  @id @default(uuid())
  customerId    String
  brand         String
  model         String
  year          Int
  plate         String  @unique
  chassisNumber String?
  color         String?
  mileage       Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  revisions Revision[]

  @@index([customerId])
  @@index([plate])
  @@map("customer_vehicles")
}

// Categorias do Checklist
model ChecklistCategory {
  id          String  @id @default(uuid())
  name        String
  description String?
  icon        String?
  isDefault   Boolean @default(false)
  isEnabled   Boolean @default(true)
  order       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items ChecklistItem[]

  @@index([order])
  @@map("checklist_categories")
}

// Itens do Checklist
model ChecklistItem {
  id          String  @id @default(uuid())
  categoryId  String
  name        String
  description String?
  isDefault   Boolean @default(false)
  isEnabled   Boolean @default(true)
  order       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category ChecklistCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([order])
  @@map("checklist_items")
}

// Revisões
model Revision {
  id              String         @id @default(uuid())
  customerId      String
  vehicleId       String
  date            DateTime
  mileage         Int?
  status          RevisionStatus @default(DRAFT)
  checklistItems  Json // Array de itens verificados com detalhes completos
  generalNotes    String?        @db.Text
  recommendations String?        @db.Text

  // Atribuição de mecânico
  mechanicName    String? // Nome do mecânico responsável
  mechanicNotes   String?        @db.Text // Notas internas do mecânico
  assignedBy      String? // Quem atribuiu a revisão (admin ID/nome)
  assignedAt      DateTime? // Quando foi atribuída

  // Campos para notificações e lembretes
  nextRevisionDate     DateTime? // Próxima revisão sugerida
  nextRevisionMileage  Int? // Quilometragem sugerida para próxima revisão
  oilChangeDate        DateTime? // Data da troca de óleo
  oilChangeMileage     Int? // Quilometragem da troca de óleo
  nextOilChangeDate    DateTime? // Próxima troca de óleo sugerida
  nextOilChangeMileage Int? // Quilometragem sugerida para próxima troca

  // Dados completos em JSON para histórico detalhado
  revisionData    Json? // Snapshot completo da revisão (cliente, veículo, itens)
  servicesPerformed String[] @default([]) // Lista de serviços realizados
  partsReplaced     String[] @default([]) // Lista de peças substituídas

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  customer Customer        @relation(fields: [customerId], references: [id])
  vehicle  CustomerVehicle @relation(fields: [vehicleId], references: [id])

  @@index([customerId])
  @@index([vehicleId])
  @@index([status])
  @@index([date])
  @@index([mechanicName])
  @@index([nextRevisionDate])
  @@index([nextOilChangeDate])
  @@map("revisions")
}

// Configuração do Programa de Fidelidade
model LoyaltySettings {
  id String @id @default(uuid())

  // Configuração de Pontos
  pointsPerReal          Decimal @default(1) @db.Decimal(10, 2) // Pontos ganhos por real gasto
  minPurchaseForPoints   Decimal @default(0) @db.Decimal(10, 2) // Valor mínimo para ganhar pontos
  pointsExpirationDays   Int?    // Dias até pontos expirarem (null = nunca)

  // Bônus por Revisão
  revisionBonusPoints    Int     @default(0) // Pontos ganhos ao fazer revisão

  // Bônus por Aniversário
  birthdayBonusPoints    Int     @default(0) // Pontos ganhos no aniversário
  birthdayBonusEnabled   Boolean @default(false)

  // Bônus por Indicação
  referralBonusPoints    Int     @default(0) // Pontos por indicar amigo
  referralBonusEnabled   Boolean @default(false)

  // Multiplicadores por Nível
  bronzeMultiplier       Decimal @default(1.0) @db.Decimal(3, 2)
  silverMultiplier       Decimal @default(1.2) @db.Decimal(3, 2)
  goldMultiplier         Decimal @default(1.5) @db.Decimal(3, 2)
  platinumMultiplier     Decimal @default(2.0) @db.Decimal(3, 2)

  // Status do Programa
  isActive               Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("loyalty_settings")
}

// Transações de Pontos (Histórico)
model PointTransaction {
  id          String                @id @default(uuid())
  customerId  String
  type        PointTransactionType
  points      Int                   // Pode ser positivo (ganho) ou negativo (gasto/expiração)
  description String

  // Referências opcionais
  orderId     String?               // Se relacionado a um pedido
  rewardId    String?               // Se relacionado a uma recompensa
  referenceId String?               // ID de referência genérico (ex: ID da revisão)

  // Metadados
  metadata    Json?                 // Dados adicionais flexíveis
  expiresAt   DateTime?             // Data de expiração desses pontos

  // Admin que executou (para transações manuais)
  executedBy  String?               // ID do admin que fez a transação manual

  createdAt   DateTime              @default(now())

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([orderId])
  @@map("point_transactions")
}

// Recompensas Disponíveis
model LoyaltyReward {
  id              String       @id @default(uuid())
  name            String
  description     String       @db.Text
  type            RewardType
  pointsCost      Int          // Custo em pontos
  status          RewardStatus @default(ACTIVE)

  // Configurações por Tipo
  discountValue   Decimal?     @db.Decimal(10, 2) // Valor do desconto (% ou R$)
  productId       String?      // ID do produto grátis
  serviceId       String?      // ID do serviço grátis
  minPurchase     Decimal?     @db.Decimal(10, 2) // Valor mínimo de compra
  maxDiscount     Decimal?     @db.Decimal(10, 2) // Desconto máximo (para %)

  // Limitações
  usageLimit      Int?         // Limite total de resgates
  usageCount      Int          @default(0) // Quantidade de resgates
  limitPerCustomer Int?        // Limite por cliente

  // Validade
  expiresAt       DateTime?    // Data de expiração da recompensa

  // Restrições de nível
  minLevel        CustomerLevel? // Nível mínimo necessário

  // Visual
  image           String?      // URL da imagem
  icon            String?      // Ícone da recompensa
  badgeColor      String?      // Cor do badge

  // Ordenação e destaque
  featured        Boolean      @default(false) // Destaque na lista
  order           Int          @default(0) // Ordem de exibição

  // Metadados
  termsAndConditions String?  @db.Text // Termos e condições

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  redemptions RedeemedReward[]

  @@index([status])
  @@index([pointsCost])
  @@index([featured])
  @@index([order])
  @@map("loyalty_rewards")
}

// Recompensas Resgatadas
model RedeemedReward {
  id         String   @id @default(uuid())
  customerId String
  rewardId   String
  pointsUsed Int      // Pontos gastos no resgate

  // Status de uso
  isUsed     Boolean  @default(false)
  usedAt     DateTime?

  // Código único para validação
  redemptionCode String @unique // Código para o cliente apresentar

  // Validade do resgate
  expiresAt  DateTime?

  // Metadados do resgate (snapshot da recompensa)
  rewardData Json     // Dados da recompensa no momento do resgate

  // Relacionado a pedido (se usado em compra)
  orderId    String?

  createdAt  DateTime @default(now())

  // Relations
  customer Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  reward   LoyaltyReward @relation(fields: [rewardId], references: [id])

  @@index([customerId])
  @@index([rewardId])
  @@index([redemptionCode])
  @@index([isUsed])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("redeemed_rewards")
}

// ============================================================================
// MODELS - RASTREIO DE PEDIDOS
// ============================================================================

// Métodos de Envio
model ShippingMethod {
  id          String  @id @default(uuid())
  name        String  @unique // Ex: "Correios PAC", "Correios SEDEX", "Transportadora XYZ"
  type        String  // CORREIOS, TRANSPORTADORA, MOTOBOY, RETIRADA
  trackingUrl String? // URL base para rastreamento. Ex: "https://rastreamento.correios.com.br/app/index.php?codigo={code}"
  isActive    Boolean @default(true)
  order       Int     @default(0) // Ordem de exibição

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trackings OrderTracking[]

  @@index([type])
  @@index([isActive])
  @@map("shipping_methods")
}

// Rastreio de Pedidos
model OrderTracking {
  id               String   @id @default(uuid())
  orderId          String   @unique
  shippingMethodId String
  trackingCode     String
  shippedAt        DateTime @default(now())
  estimatedDelivery DateTime?
  deliveredAt      DateTime?
  notes            String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shippingMethod ShippingMethod @relation(fields: [shippingMethodId], references: [id])

  @@index([orderId])
  @@index([shippingMethodId])
  @@index([trackingCode])
  @@map("order_trackings")
}
