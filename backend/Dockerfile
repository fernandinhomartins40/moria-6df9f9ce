# ========================================
# DOCKERFILE BACKEND - MORIA PRISMA
# ‚úÖ ELIMINA complexidades de build manual
# ‚úÖ Otimizado para Prisma + SQLite
# ‚úÖ Multi-stage build para produ√ß√£o
# ========================================

FROM node:18-alpine AS base

# Instalar depend√™ncias do sistema para Prisma + SQLite
RUN apk add --no-cache \
    sqlite \
    openssl \
    ca-certificates \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Copiar package files para cache de depend√™ncias
COPY package*.json ./
COPY prisma ./prisma/

# ========================================
# STAGE: DEPENDENCIES
# ========================================
FROM base AS deps

# Instalar depend√™ncias (incluindo dev para Prisma generate)
RUN npm ci --include=dev

# Gerar Prisma Client (necess√°rio antes do build)
RUN npx prisma generate

# ========================================
# STAGE: BUILDER
# ========================================
FROM base AS builder

# Copiar node_modules do stage anterior
COPY --from=deps /app/node_modules ./node_modules

# Copiar c√≥digo fonte
COPY . .

# Gerar Prisma Client para produ√ß√£o
RUN npx prisma generate

# ‚ùå REMOVIDO: npm prune estava removendo depend√™ncias do Prisma
# RUN npm prune --production

# ========================================
# STAGE: PRODUCTION
# ========================================
FROM node:18-alpine AS production

# Instalar depend√™ncias runtime + curl para health checks
RUN apk add --no-cache \
    sqlite \
    openssl \
    curl \
    && rm -rf /var/cache/apk/*

# Criar usu√°rio n√£o-root para seguran√ßa
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /app

# Copiar arquivos de produ√ß√£o
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./
COPY --from=builder --chown=nodejs:nodejs /app/prisma ./prisma/
COPY --from=builder --chown=nodejs:nodejs /app/src ./src/
COPY --from=builder --chown=nodejs:nodejs /app/server.js ./server.js
# knexfile.js removido - usando apenas Prisma

# Criar diret√≥rios necess√°rios
RUN mkdir -p /app/data /app/uploads /app/logs && \
    chown -R nodejs:nodejs /app/data /app/uploads /app/logs

# Configurar vari√°veis de ambiente
ENV NODE_ENV=production
ENV DATABASE_URL=file:/app/data/moria.db

# Configurar usu√°rio
USER nodejs

# Expor porta
EXPOSE 3001

# ‚ùå REMOVIDO: Health check movido para docker-compose para evitar conflitos
# HEALTHCHECK definido apenas no docker-compose.yml

# ‚úÖ Script de inicializa√ß√£o com DEBUG COMPLETO
CMD ["sh", "-c", "\
echo 'üîç === DEBUG CONTAINER STARTUP ===' && \
echo 'üìã Verificando arquivos...' && \
ls -la /app/ && \
echo 'üìã Verificando node modules...' && \
ls -la /app/node_modules/ | head -10 && \
echo 'üìã Verificando prisma...' && \
ls -la /app/prisma/ && \
echo 'üìã Tentando prisma db push...' && \
npx prisma db push --accept-data-loss && \
echo 'üìã Tentando iniciar servidor...' && \
echo 'üìã Vari√°veis de ambiente:' && \
echo PORT=$PORT && echo HOST=$HOST && echo NODE_ENV=$NODE_ENV && \
echo 'üöÄ Iniciando node server.js...' && \
node server.js"]