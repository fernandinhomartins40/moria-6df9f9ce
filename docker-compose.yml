# ============================================
# Docker Compose - Moria Peças & Serviços
# Frontend React + Backend Node.js + Nginx
# ============================================

version: '3.8'

services:
  # Backend API Node.js
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BUILD_TIMESTAMP=${BUILD_TIMESTAMP:-}
    container_name: moria-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-3031}:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - HOST=0.0.0.0
      - JWT_SECRET=${JWT_SECRET:-moria-super-secret-jwt-key-change-in-production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      - REFRESH_TOKEN_EXPIRES_IN=${REFRESH_TOKEN_EXPIRES_IN:-7d}
      - DATABASE_URL=/app/database/database.sqlite
      - VPS_HOST=${VPS_HOST:-72.60.10.108}
      - FRONTEND_PORT=${FRONTEND_PORT:-3030}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://72.60.10.108:3030,http://localhost:3000,http://localhost:5173,http://localhost:8080}
      - CORS_CREDENTIALS=${CORS_CREDENTIALS:-true}
      # Logging (Fase 3)
      - LOG_LEVEL=${LOG_LEVEL:-warn}
      - LOG_FILE=${LOG_FILE:-true}
      - ENABLE_REQUEST_LOGGING=${ENABLE_REQUEST_LOGGING:-false}
      # Rate Limiting (Fase 4)
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - ENABLE_RATE_LIMITING=${ENABLE_RATE_LIMITING:-true}
      # Features
      - ENABLE_CORS=${ENABLE_CORS:-true}
      - ENABLE_COMPRESSION=${ENABLE_COMPRESSION:-true}
      # Security
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-12}
      - SESSION_SECRET=${SESSION_SECRET:-your-super-secure-session-secret-here-minimum-32-characters}
      # Uploads
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-5242880}
      - UPLOAD_ALLOWED_TYPES=${UPLOAD_ALLOWED_TYPES:-image/jpeg,image/png,image/webp,image/gif}
      # API Configuration
      - API_PREFIX=${API_PREFIX:-/api}
      - API_VERSION=${API_VERSION:-v1}
      # Application Metadata
      - APP_NAME=${APP_NAME:-Moria Backend}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - APP_DESCRIPTION=${APP_DESCRIPTION:-Sistema de gestão automotiva}
      # Redis (opcional para rate limiting distribuído)
      - REDIS_URL=${REDIS_URL:-}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - backend_data:/app/database
    networks:
      - moria-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend React + Nginx
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_TIMESTAMP=${BUILD_TIMESTAMP:-}
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://72.60.10.108:3031/api}
        - VITE_APP_NAME=${VITE_APP_NAME:-Moria Peças & Serviços}
    container_name: moria-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3030}:80"
    depends_on:
      - backend
    networks:
      - moria-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Proxy Reverso Nginx (Opcional - para produção)
  nginx-proxy:
    image: nginx:alpine
    container_name: moria-proxy
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - frontend
      - backend
    networks:
      - moria-network
    profiles:
      - production

volumes:
  backend_data:
    driver: local
    name: moria_backend_data

networks:
  moria-network:
    driver: bridge
    name: moria_network

# ============================================
# COMANDOS ÚTEIS:
#
# Desenvolvimento:
# docker-compose up --build
#
# Produção:
# docker-compose --profile production up --build -d
#
# Rebuild específico:
# docker-compose up --build backend
# docker-compose up --build frontend
#
# Logs:
# docker-compose logs -f backend
# docker-compose logs -f frontend
#
# Backup do banco:
# docker-compose exec backend cp /app/database/database.sqlite /tmp/
# docker cp moria-backend:/tmp/database.sqlite ./backup/
# ============================================