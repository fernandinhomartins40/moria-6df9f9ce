name: ðŸš€ Deploy Incremental - Preserva Dados

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo do deploy incremental'
        required: false
        default: 'AtualizaÃ§Ã£o de cÃ³digo'

jobs:
  deploy-incremental:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ—ï¸ Build frontend
        run: npm run build

      - name: ðŸ“‹ Criar pacote de atualizaÃ§Ã£o
        run: |
          # Criar diretÃ³rio temporÃ¡rio para o update
          mkdir -p update-package
          
          # Copiar apenas arquivos necessÃ¡rios (SEM banco de dados)
          cp -r dist/ update-package/
          cp -r backend/src/ update-package/backend-src/
          cp -r backend/prisma/ update-package/backend-prisma/
          cp backend/package.json update-package/backend-package.json
          cp backend/package-lock.json update-package/backend-package-lock.json
          cp package.json update-package/
          cp package-lock.json update-package/
          
          # Copiar arquivos opcionais apenas se existirem
          [ -f docker-entrypoint.sh ] && cp docker-entrypoint.sh update-package/ || echo "âš ï¸ docker-entrypoint.sh nÃ£o encontrado"
          [ -f Dockerfile ] && cp Dockerfile update-package/ || echo "âš ï¸ Dockerfile nÃ£o encontrado"
          [ -f nginx-full.conf ] && cp nginx-full.conf update-package/ || echo "âš ï¸ nginx-full.conf nÃ£o encontrado"
          [ -f nginx.conf ] && cp nginx.conf update-package/ || echo "âš ï¸ nginx.conf nÃ£o encontrado"
          
          # Criar arquivo de versÃ£o
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > update-package/version.txt
          echo "COMMIT_SHA=${{ github.sha }}" >> update-package/version.txt
          echo "REASON=${{ github.event.inputs.reason }}" >> update-package/version.txt
          
          # Comprimir pacote
          tar -czf moria-update.tar.gz -C update-package .

      - name: ðŸšš Transferir arquivos via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          source: "./moria-update.tar.gz"
          target: "/tmp/"

      - name: ðŸšš Deploy para VPS (Incremental)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            
            echo "ðŸ”„ Iniciando deploy incremental..."
            
            # Definir variÃ¡veis
            PROJECT_DIR="/root/moria-pecas-servicos"
            BACKUP_DIR="/root/backups/moria"
            UPDATE_DIR="/tmp/moria-update"
            
            # Criar diretÃ³rio de backup se nÃ£o existir
            mkdir -p $BACKUP_DIR
            
            # 1. BACKUP DO BANCO ATUAL
            echo "ðŸ’¾ Fazendo backup do banco de dados..."
            if [ -f "$PROJECT_DIR/backend/prisma/database.db" ]; then
              cp "$PROJECT_DIR/backend/prisma/database.db" "$BACKUP_DIR/database-$(date +%Y%m%d-%H%M%S).db"
              echo "âœ… Backup do banco salvo em $BACKUP_DIR"
            else
              echo "âš ï¸  Banco de dados nÃ£o encontrado - primeiro deploy?"
            fi
            
            # 2. PARAR CONTAINER ATUAL
            echo "ðŸ›‘ Parando container atual..."
            docker stop moria-app || true
            docker rm moria-app || true
            
            # 3. EXTRAIR NOVA VERSÃƒO
            echo "ðŸ“¥ Extraindo nova versÃ£o..."
            rm -rf $UPDATE_DIR
            mkdir -p $UPDATE_DIR
            
            # Usar arquivo transferido via SCP
            cd /tmp
            if [ -f "moria-update.tar.gz" ]; then
              echo "âœ… Arquivo encontrado, extraindo..."
              tar -xzf moria-update.tar.gz -C $UPDATE_DIR --strip-components=1
              rm moria-update.tar.gz
              echo "âœ… ExtraÃ§Ã£o concluÃ­da"
            else
              echo "âŒ Arquivo nÃ£o encontrado - falha na transferÃªncia"
              exit 1
            fi
            
            # 4. PRESERVAR BANCO DE DADOS
            echo "ðŸ”’ Preservando banco de dados..."
            if [ -f "$PROJECT_DIR/backend/prisma/database.db" ]; then
              # Salvar banco atual
              cp "$PROJECT_DIR/backend/prisma/database.db" "/tmp/database-preserve.db"
              echo "âœ… Banco preservado temporariamente"
            fi
            
            # 5. ATUALIZAR CÃ“DIGO
            echo "ðŸ”„ Atualizando cÃ³digo..."
            
            # Listar arquivos que estÃ£o sendo atualizados
            echo "ðŸ“‹ Listando arquivos para atualizaÃ§Ã£o:"
            
            echo "ðŸ“ Arquivos existentes (serÃ£o atualizados):"
            if [ -d "$PROJECT_DIR" ]; then
              find $PROJECT_DIR -type f -name "*.js" -o -name "*.json" -o -name "*.html" -o -name "*.css" | head -10 | sed 's|^|   âœï¸  |'
              EXISTING_COUNT=$(find $PROJECT_DIR -type f | wc -l)
              echo "   ðŸ“Š Total de arquivos existentes: $EXISTING_COUNT"
            else
              echo "   â„¹ï¸  Nenhum arquivo existente (primeira instalaÃ§Ã£o)"
            fi
            
            echo ""
            echo "ðŸ“ Novos arquivos (serÃ£o adicionados):"
            find $UPDATE_DIR -type f -name "*.js" -o -name "*.json" -o -name "*.html" -o -name "*.css" | head -10 | sed 's|^|   âž• |'
            NEW_COUNT=$(find $UPDATE_DIR -type f | wc -l)
            echo "   ðŸ“Š Total de arquivos novos: $NEW_COUNT"
            
            echo ""
            echo "ðŸ”„ Realizando atualizaÃ§Ã£o..."
            rm -rf $PROJECT_DIR
            mv $UPDATE_DIR $PROJECT_DIR
            
            # 6. RESTAURAR BANCO DE DADOS
            echo "ðŸ”™ Restaurando banco de dados..."
            if [ -f "/tmp/database-preserve.db" ]; then
              mkdir -p "$PROJECT_DIR/backend/prisma"
              mv "/tmp/database-preserve.db" "$PROJECT_DIR/backend/prisma/database.db"
              echo "âœ… Banco de dados restaurado"
            fi
            
            # 7. REORGANIZAR ESTRUTURA DE DIRETÃ“RIOS
            echo "ðŸ”§ Reorganizando estrutura..."
            cd $PROJECT_DIR
            
            # Criar estrutura backend correta
            mkdir -p backend/src backend/prisma
            
            echo "ðŸ“ Organizando arquivos do backend:"
            # Mover arquivos para locais corretos
            if [ -d "backend-src" ]; then
              echo "   ðŸ“‚ Movendo arquivos fonte do backend..."
              find backend-src -type f | head -5 | sed 's|^|      ðŸ”§ |'
              SRC_COUNT=$(find backend-src -type f | wc -l)
              echo "      ðŸ“Š Total de arquivos fonte: $SRC_COUNT"
              cp -r backend-src/* backend/src/
              rm -rf backend-src
            fi
            
            if [ -d "backend-prisma" ]; then
              echo "   ðŸ“‚ Movendo arquivos Prisma..."
              find backend-prisma -type f | head -5 | sed 's|^|      ðŸ—ƒï¸  |'
              PRISMA_COUNT=$(find backend-prisma -type f | wc -l)
              echo "      ðŸ“Š Total de arquivos Prisma: $PRISMA_COUNT"
              cp -r backend-prisma/* backend/prisma/
              rm -rf backend-prisma
            fi
            
            echo "   ðŸ“„ Organizando arquivos de configuraÃ§Ã£o:"
            # Organizar arquivos package.json e package-lock.json
            if [ -f "backend-package.json" ]; then
              echo "      ðŸ“¦ backend/package.json"
              mv backend-package.json backend/package.json
            fi
            
            if [ -f "backend-package-lock.json" ]; then
              echo "      ðŸ”’ backend/package-lock.json"
              mv backend-package-lock.json backend/package-lock.json
            fi
            
            # Mostrar estrutura final
            echo "   ðŸ“‹ Estrutura final criada:"
            echo "      ðŸ“ backend/src ($(find backend/src -type f | wc -l) arquivos)"
            echo "      ðŸ“ backend/prisma ($(find backend/prisma -type f | wc -l) arquivos)"
            echo "      ðŸ“ dist ($(find dist -type f | wc -l) arquivos estÃ¡ticos)"
            
            # 8. INSTALAR DEPENDÃŠNCIAS DO BACKEND
            echo "ðŸ“¦ Instalando dependÃªncias do backend..."
            cd backend
            npm install --production
            
            # 9. GERAR CLIENTE PRISMA (sem migration)
            echo "ðŸ”§ Regenerando cliente Prisma..."
            npx prisma generate
            
            
            # 10. REBUILD CONTAINER
            echo "ðŸ—ï¸ Reconstruindo container..."
            cd $PROJECT_DIR
            docker build -t moria-pecas-servicos:latest .
            
            # 11. REINICIAR CONTAINER
            echo "ðŸš€ Iniciando novo container..."
            docker run -d \
              --name moria-app \
              --restart unless-stopped \
              -p 3018:80 \
              -v $PROJECT_DIR/backend/prisma:/app/backend/prisma \
              moria-pecas-servicos:latest
            
            # 12. AGUARDAR INICIALIZAÃ‡ÃƒO
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 15
            
            # DEBUG: Verificar status do container
            echo "ðŸ” Debug - Status do container:"
            docker ps -a --filter name=moria-app
            echo "ðŸ“ Debug - Logs do container:"
            docker logs moria-app --tail 20
            
            # 13. VERIFICAR SAÃšDE
            echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
            echo "Debug - Testando curl..."
            curl -v http://localhost:3018/api/health || echo "âŒ Curl falhou"
            
            if curl -f http://localhost:3018/api/health > /dev/null 2>&1; then
              echo "âœ… Deploy incremental concluÃ­do com sucesso!"
              echo "ðŸ“Š Verificando dados preservados..."
              
              # Verificar se dados foram preservados
              PRODUCTS=$(curl -s http://localhost:3018/api/products | jq -r '.total // 0')
              SERVICES=$(curl -s http://localhost:3018/api/services | jq -r '.total // 0')  
              PROMOTIONS=$(curl -s http://localhost:3018/api/promotions | jq -r '.total // 0')
              
              echo "ðŸ“ˆ Status dos dados:"
              echo "   â€¢ Produtos: $PRODUCTS"
              echo "   â€¢ ServiÃ§os: $SERVICES" 
              echo "   â€¢ PromoÃ§Ãµes: $PROMOTIONS"
              
              if [ "$PRODUCTS" -gt 0 ] || [ "$SERVICES" -gt 0 ]; then
                echo "ðŸŽ‰ Dados preservados com sucesso!"
              else
                echo "âš ï¸  AtenÃ§Ã£o: PossÃ­vel perda de dados - verificar backup"
              fi
              
              echo ""
              echo "ðŸ“‹ Resumo da atualizaÃ§Ã£o:"
              echo "   âœï¸  Arquivos atualizados: $EXISTING_COUNT"
              echo "   âž• Arquivos novos: $NEW_COUNT"
              echo "   ðŸ”§ Arquivos backend: $SRC_COUNT"
              echo "   ðŸ—ƒï¸  Arquivos Prisma: $PRISMA_COUNT"
              echo "   ðŸ“¦ DependÃªncias instaladas: $(cat backend/package.json | jq -r '.dependencies | keys | length') pacotes"
              echo "   ðŸ’¾ Banco de dados: Preservado e funcionando"
              
            else
              echo "âŒ Falha no deploy - aplicaÃ§Ã£o nÃ£o estÃ¡ respondendo"
              exit 1
            fi
            
            # 14. LIMPEZA
            echo "ðŸ§¹ Limpeza de arquivos temporÃ¡rios..."
            rm -rf /tmp/moria-update
            docker system prune -f --volumes=false
            
            echo "âœ¨ Deploy incremental finalizado!"
            echo "ðŸ”— AplicaÃ§Ã£o disponÃ­vel em: http://31.97.85.98:3018"

      - name: ðŸ“ˆ RelatÃ³rio do Deploy
        if: always()
        run: |
          echo "## ðŸ“‹ RelatÃ³rio do Deploy Incremental" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Motivo:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ• Data:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Arquivos IncluÃ­dos no Deploy:" >> $GITHUB_STEP_SUMMARY
          echo "| Categoria | Quantidade | Exemplos |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (dist) | $(find dist -type f 2>/dev/null | wc -l || echo 0) | HTML, CSS, JS compilados |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (src) | $(find backend/src -type f 2>/dev/null | wc -l || echo 0) | APIs, serviÃ§os, controllers |" >> $GITHUB_STEP_SUMMARY
          echo "| Prisma | $(find backend/prisma -type f 2>/dev/null | wc -l || echo 0) | Schema, migrations |" >> $GITHUB_STEP_SUMMARY
          echo "| ConfiguraÃ§Ã£o | $(ls -1 *.json *.js *.sh 2>/dev/null | wc -l || echo 0) | package.json, Dockerfile |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”„ Principais Arquivos Atualizados:" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** Novos utilitÃ¡rios em \`src/utils/dataTransform.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** APIs atualizadas em \`backend/src/routes/api.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Schema:** Novos campos de produto em \`backend/prisma/schema.prisma\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Hooks:** Nomenclatura sincronizada em \`src/hooks/useAdmin*.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- **DocumentaÃ§Ã£o:** ConvenÃ§Ã£o estabelecida em \`NAMING_CONVENTION.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… CaracterÃ­sticas do Deploy Incremental:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¾ **Banco de dados preservado** (backup automÃ¡tico)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ **Apenas cÃ³digo atualizado**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Dados existentes mantidos**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **Zero downtime** (mÃ­nimo possÃ­vel)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”™ **Backup automÃ¡tico** antes da atualizaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ **Log detalhado** de arquivos processados" >> $GITHUB_STEP_SUMMARY