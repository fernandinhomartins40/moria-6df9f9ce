name: ğŸš€ Deploy Moria Pecas e Servicos - Full Stack

# FORCE CACHE INVALIDATION - Moria Prisma + Docker Complete - 2025-09-17T18:00:00Z

concurrency:
  group: moria-deploy-fullstack
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.108'
  VPS_USER: 'root'
  APP_DIR: '/root/moria-pecas-servicos'
  APP_PORT: '3030'  # Padronizando para porta 3030
  COMPOSE_PROJECT: 'moria'

jobs:
  deploy:
    name: ğŸš€ Deploy Full Stack para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”‘ Setup SSH Tools
      run: |
        echo "ğŸ”‘ Instalando ferramentas SSH..."
        sudo apt-get update -q
        sudo apt-get install -y sshpass
        echo "âœ… Ferramentas SSH instaladas"

    - name: ğŸ” Pre-Deploy Validation
      run: |
        echo "ğŸ” Validando estrutura do projeto MORIA FULL STACK..."
        echo "ğŸ“‹ Frontend:"
        ls -la frontend/package.json frontend/vite.config.js frontend/src/ || echo "âš ï¸ Arquivos frontend faltando"
        echo "ğŸ“‹ Backend:"
        ls -la backend/package.json backend/server.js backend/Dockerfile || echo "âš ï¸ Arquivos backend faltando"
        ls -la backend/prisma/schema.prisma || echo "âš ï¸ Schema Prisma faltando"
        echo "ğŸ“‹ Docker:"
        ls -la docker-compose.yml nginx.conf Dockerfile.nginx || echo "âš ï¸ Arquivos Docker faltando"
        
        # Validar arquivos de configuraÃ§Ã£o
        echo "ğŸ“‹ Validando arquivos de configuraÃ§Ã£o..."
        if [ ! -f "docker-compose.yml" ]; then
          echo "âŒ docker-compose.yml nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "nginx.conf" ]; then
          echo "âŒ nginx.conf nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "backend/prisma/schema.prisma" ]; then
          echo "âŒ backend/prisma/schema.prisma nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "frontend/package.json" ]; then
          echo "âŒ frontend/package.json nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "backend/package.json" ]; then
          echo "âŒ backend/package.json nÃ£o encontrado!"
          exit 1
        fi
        
        echo "âœ… Todos os arquivos essenciais encontrados!"

    - name: ğŸ“¦ Prepare Full Stack Package
      run: |
        echo "ğŸ“¦ Preparando pacote MORIA FULL STACK..."
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Backend: Node.js + Prisma + SQLite"
        echo "Frontend: React + Vite"
        echo "Infraestrutura: Docker + nginx proxy"

        # Criar arquivo compacto
        tar --warning=no-file-changed -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='**/node_modules' \
          --exclude='frontend/dist' \
          --exclude='backend/dist' \
          --exclude='build' \
          --exclude='*.log' \
          --exclude='coverage' \
          --exclude='.env.local' \
          --exclude='backend/data' \
          --exclude='backend/uploads' \
          --exclude='backend/logs' \
          --exclude='nginx-logs' \
          --exclude='backups' \
          --exclude='docs' \
          . || true

        echo "ğŸ“Š Tamanho do pacote FULL STACK:"
        ls -lh deploy.tar.gz

    - name: ğŸ“¤ Upload to VPS
      run: |
        echo "ğŸ“¤ Enviando FULL STACK para VPS..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

    - name: ğŸš€ Deploy Full Stack on VPS
      run: |
        echo "ğŸ—ï¸ Executando deploy FULL STACK na VPS..."
        echo "ğŸ“‹ InformaÃ§Ãµes do deploy:"
        echo "  ğŸ“¦ Commit: ${{ github.sha }}"
        echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "  ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "  ğŸ• Timestamp: $(date -u)"
        echo "  ğŸ¯ Stack: Node.js Backend + React Frontend"

        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << DEPLOY_SCRIPT
          set -e

          echo 'ğŸš€ Iniciando deploy MORIA FULL STACK - Node.js + React'

          # Configurar sistema
          echo 'ğŸ“¦ Configurando VPS...'
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get install -y curl wget gnupg2 software-properties-common apt-transport-https ca-certificates lsb-release

          # Parar stack anterior (se existir)
          echo 'â¹ï¸ Parando stack anterior...'
          if command -v docker &> /dev/null; then
            # Parar todos os containers do projeto Moria
            docker compose -p ${{ env.COMPOSE_PROJECT }} down --volumes --remove-orphans 2>/dev/null || true
            docker compose -p moria down --volumes --remove-orphans 2>/dev/null || true

            # Parar containers especÃ­ficos se ainda estiverem rodando
            docker stop moria-backend moria-nginx moria-frontend 2>/dev/null || true
            docker rm -f moria-backend moria-nginx moria-frontend 2>/dev/null || true

            # Remover APENAS as imagens do Moria (especÃ­ficas)
            echo 'ğŸ—‘ï¸ Removendo imagens antigas do Moria...'
            docker images --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}" | grep -E "moria" | awk '{print $2}' | xargs -r docker rmi -f 2>/dev/null || true

            # Liberar porta da aplicaÃ§Ã£o forÃ§adamente
            docker ps --filter "publish=${{ env.APP_PORT }}" --format "table {{.ID}}" | tail -n +2 | xargs -r docker stop 2>/dev/null || true

            # Remover apenas volumes especÃ­ficos do moria
            docker volume ls --format "table {{.Name}}" | grep -E "moria" | xargs -r docker volume rm 2>/dev/null || true
            
            # Remover networks antigas do moria
            echo 'ğŸ§¹ Removendo networks antigas do Moria...'
            docker network ls --format "table {{.Name}}" | grep -E "moria" | xargs -r docker network rm 2>/dev/null || true

            # Remover volumes Ã³rfÃ£os do moria
            echo 'ğŸ§¹ Removendo volumes Ã³rfÃ£os do Moria...'
            docker volume ls --format "table {{.Name}}" | grep -E "moria" | xargs -r docker volume rm 2>/dev/null || true

            echo 'âœ… Stack anterior parada, imagens antigas removidas e portas liberadas'
          fi

          # Instalar/Atualizar Docker
          echo 'ğŸ³ Configurando Docker + Compose...'
          if ! command -v docker &> /dev/null; then
            # Instalar Docker
            apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update -y
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            systemctl start docker && systemctl enable docker
          fi
          docker --version && docker compose version

          # Backup e preparaÃ§Ã£o
          if [ -d '${{ env.APP_DIR }}' ]; then
            echo 'ğŸ’¾ Fazendo backup...'
            mv '${{ env.APP_DIR }}' '${{ env.APP_DIR }}.backup.\$(date +%Y%m%d-%H%M%S)' 2>/dev/null || true
          fi

          # Extrair cÃ³digo
          echo 'ğŸ“ Extraindo FULL STACK...'
          mkdir -p ${{ env.APP_DIR }} && cd ${{ env.APP_DIR }}
          tar -xzf /tmp/deploy.tar.gz && rm -f /tmp/deploy.tar.gz

          # Validar estrutura
          echo 'ğŸ” Validando estrutura MORIA FULL STACK...'
          ls -la docker-compose.yml nginx.conf Dockerfile.nginx || { echo 'âŒ Arquivos essenciais faltando!'; exit 1; }
          ls -la backend/Dockerfile backend/package.json backend/server.js || { echo 'âŒ Backend incompleto!'; exit 1; }
          ls -la backend/prisma/schema.prisma || { echo 'âŒ Schema Prisma faltando!'; exit 1; }
          ls -la frontend/package.json frontend/vite.config.js || { echo 'âŒ Frontend incompleto!'; exit 1; }

          # Configurar variÃ¡veis de produÃ§Ã£o
          echo 'âš™ï¸ Configurando ambiente de produÃ§Ã£o...'
          echo "VPS_HOST=${{ env.VPS_HOST }}" > .env.production
          echo "APP_PORT=${{ env.APP_PORT }}" >> .env.production
          echo "NGINX_PORT=${{ env.APP_PORT }}" >> .env.production
          echo "FRONTEND_PORT=${{ env.APP_PORT }}" >> .env.production
          echo "BACKEND_PORT=3001" >> .env.production
          echo "JWT_SECRET=moria-production-jwt-${{ github.sha }}" >> .env.production
          echo "NODE_ENV=production" >> .env.production
          echo "DATABASE_URL=file:/app/data/moria.db" >> .env.production
          echo "DIRECT_URL=file:/app/data/moria.db" >> .env.production
          echo "CORS_ORIGIN=http://${{ env.VPS_HOST }}:${{ env.APP_PORT }},http://localhost:3000,http://localhost:5173" >> .env.production
          echo "UPLOAD_MAX_SIZE=10485760" >> .env.production
          echo "LOG_LEVEL=info" >> .env.production
          echo "APP_NAME=Moria Pecas e Servicos" >> .env.production
          echo "APP_VERSION=2.0.0" >> .env.production

          # Deploy com Docker Compose
          echo 'ğŸ³ Executando deploy com Docker Compose...'
          export NGINX_PORT=${{ env.APP_PORT }}
          export BUILD_TIMESTAMP=\$(date +%s)
          export JWT_SECRET=moria-production-jwt-${{ github.sha }}

          # Verificar se porta estÃ¡ realmente livre
          echo 'ğŸ” Verificando porta antes do deploy...'
          if netstat -tuln | grep -q ":${{ env.APP_PORT }} "; then
            echo "âš ï¸ Porta ${{ env.APP_PORT }} ainda ocupada, forÃ§ando liberaÃ§Ã£o..."
            fuser -k ${{ env.APP_PORT }}/tcp 2>/dev/null || true
            sleep 5  # Aumentando o tempo de espera
          fi

          # Build e start dos serviÃ§os com invalidaÃ§Ã£o forÃ§ada de cache
          echo 'ğŸ—ï¸ Building imagens com invalidaÃ§Ã£o total de cache...'

          # Remover APENAS imagens do moria (sem afetar outras aplicaÃ§Ãµes)\n          echo 'ğŸ§¹ Limpeza final de imagens do Moria antes do build...'\n          docker images --format \"table {{.Repository}}:{{.Tag}}\t{{.ID}}\" | grep -E \"moria\" | awk '{print $2}' | xargs -r docker rmi -f 2>/dev/null || true\n          \n          # Remover networks antigas do moria\n          echo 'ğŸ§¹ Removendo networks antigas do Moria...'\n          docker network ls --format \"table {{.Name}}\" | grep -E \"moria\" | xargs -r docker network rm 2>/dev/null || true\n\n          # Remover volumes Ã³rfÃ£os do moria\n          echo 'ğŸ§¹ Removendo volumes Ã³rfÃ£os do Moria...'\n          docker volume ls --format \"table {{.Name}}\" | grep -E \"moria\" | xargs -r docker volume rm 2>/dev/null || true

          # Build com cache totalmente limpo e timestamp Ãºnico
          echo 'ğŸ”¨ Construindo imagens completamente novas...'
          BUILD_TIMESTAMP=\$(date +%s)
          DOCKER_BUILDKIT=1 docker compose -p ${{ env.COMPOSE_PROJECT }} build --no-cache --pull --build-arg BUILD_TIMESTAMP=\$BUILD_TIMESTAMP

          echo 'ğŸš€ Iniciando containers...'

          # Tentar start normal primeiro
          if ! docker compose -p ${{ env.COMPOSE_PROJECT }} up -d; then
            echo 'âš ï¸ Falha no start normal, tentando restart forÃ§ado...'

            # Restart especÃ­fico do moria apenas
            docker compose -p ${{ env.COMPOSE_PROJECT }} down --volumes --remove-orphans 2>/dev/null || true
            echo 'âš ï¸ Reiniciando apenas containers do Moria...'

            # Aguardar um pouco
            sleep 10

            # Tentar novamente
            echo 'ğŸ”„ Tentativa 2: Iniciando containers...'
            docker compose -p ${{ env.COMPOSE_PROJECT }} up -d
          fi

          # Aguardar inicializaÃ§Ã£o
          echo 'â³ Aguardando stack inicializar (60s)...'
          sleep 60  # Aumentando o tempo de espera para 60 segundos

          # Verificar serviÃ§os
          echo 'ğŸ” Verificando serviÃ§os...'
          docker compose -p ${{ env.COMPOSE_PROJECT }} ps

          # Testar aplicaÃ§Ã£o (via nginx proxy)
          echo 'ğŸ” Testando aplicaÃ§Ã£o...'
          for i in {1..15}; do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/health >/dev/null 2>&1; then
              echo 'âœ… Nginx proxy health check passou!'
              break
            fi
            echo "Nginx proxy - Tentativa \$i/15 - aguardando 5s..."
            sleep 5
          done

          # Testar API backend via proxy
          echo 'ğŸ” Testando API backend via proxy...'
          for i in {1..12}; do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/api/health >/dev/null 2>&1; then
              echo 'âœ… Backend API health check passou!'
              break
            fi
            echo "Backend API - Tentativa \$i/12 - aguardando 5s..."
            sleep 5
          done

          # VerificaÃ§Ã£o final
          echo 'ğŸ¯ VerificaÃ§Ã£o final...'
          if curl -f -s http://localhost:${{ env.APP_PORT }}/health >/dev/null 2>&1 && curl -f -s http://localhost:${{ env.APP_PORT }}/api/health >/dev/null 2>&1; then
            echo 'âœ… DEPLOY FULL STACK CONCLUÃDO COM SUCESSO!'
            echo 'ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}'
            echo 'ğŸ”Œ Backend API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api'
            echo 'ğŸ©º Health: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health'
          else
            echo 'âŒ Falha na verificaÃ§Ã£o final!'
            echo 'ğŸ” Exibindo logs detalhados...'
            docker compose -p ${{ env.COMPOSE_PROJECT }} logs --tail 50
            exit 1
          fi
        DEPLOY_SCRIPT

    - name: ğŸ‰ Full Stack Deploy Success
      run: |
        echo "ğŸ‰ MORIA PEÃ‡AS & SERVIÃ‡OS FULL STACK DEPLOYADO!"
        echo "âœ… Backend Node.js + Prisma + Frontend React em produÃ§Ã£o"
        echo ""
        echo "ğŸ”— LINKS FUNCIONAIS (ENTRADA ÃšNICA):"
        echo "ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "ğŸ”Œ Backend API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api"
        echo "ğŸ©º Health Check: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
        echo "ğŸª Painel Lojista: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/store-panel"
        echo "ğŸ‘¤ Painel Cliente: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/customer"
        echo ""
        echo "âœ… Stack Completa:"
        echo "  ğŸ¯ Backend: Node.js + Prisma + SQLite"
        echo "  ğŸ¨ Frontend: React + Vite"
        echo "  ğŸ³ Deploy: Docker Compose orchestration"
        echo "  ğŸ“¦ ORM: Prisma type-safe database"
        echo "  ğŸ›’ Carrinho com promoÃ§Ãµes do backend"
        echo "  ğŸ” AutenticaÃ§Ã£o JWT segura"
        echo "  ğŸ—„ï¸ Dados persistidos via Prisma"
        echo "  ğŸš€ Scripts: deploy + backup automÃ¡ticos"