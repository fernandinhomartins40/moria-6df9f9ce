name: ğŸ”§ Deploy Moria PeÃ§as e ServiÃ§os - REBUILD COMPLETO

concurrency:
  group: moria-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/root/moria-pecas-servicos'
  PORT: '3018'
  IMAGE_NAME: 'moria-pecas-servicos'
  CONTAINER_NAME: 'moria-app'

jobs:
  deploy:
    name: ğŸš€ Deploy COMPLETO para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”‘ Instalar SSH Tools
      run: |
        echo "ğŸ”‘ Instalando ferramentas SSH..."
        sudo apt-get update -q
        sudo apt-get install -y sshpass
        echo "âœ… Ferramentas SSH instaladas"

    - name: ğŸš€ Deploy COMPLETO - SEM CACHE
      run: |
        echo "ğŸ”§ Iniciando deploy COMPLETO do Moria PeÃ§as e ServiÃ§os..."
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "âš ï¸  REBUILD COMPLETO - TODOS OS ARQUIVOS SERÃƒO SUBSTITUÃDOS"
        
        # Criar arquivo com cÃ³digo
        echo "ğŸ“¦ Preparando cÃ³digo..."
        tar --warning=no-file-changed -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='dist' \
          --exclude='build' \
          --exclude='*.log' \
          --exclude='coverage' \
          --exclude='.env.local' \
          --exclude='test-backend.md' \
          . || true
        
        # Enviar para VPS
        echo "ğŸ“¤ Enviando para VPS..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/
        
        # Deploy COMPLETO na VPS
        echo "ğŸ—ï¸ Executando deploy COMPLETO na VPS..."
        echo "ğŸ“‹ InformaÃ§Ãµes do deploy:"
        echo "  ğŸ“¦ Commit: ${{ github.sha }}"
        echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "  ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "  ğŸ• Timestamp: $(date)"
        
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          set -e
          
          echo 'ğŸ—‘ï¸  REMOVENDO TUDO - REBUILD COMPLETO'
          
          # Parar e remover container
          echo 'â¹ï¸  Parando container anterior...'
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rmi ${{ env.IMAGE_NAME }}:latest 2>/dev/null || true
          
          # REMOVER COMPLETAMENTE o diretÃ³rio anterior
          echo 'ğŸ—‘ï¸  Removendo diretÃ³rio anterior COMPLETAMENTE...'
          rm -rf ${{ env.APP_DIR }}
          
          # Criar diretÃ³rio limpo
          echo 'ğŸ“ Criando diretÃ³rio limpo...'
          mkdir -p ${{ env.APP_DIR }}
          
          # Extrair cÃ³digo
          echo 'ğŸ“¦ Extraindo cÃ³digo COMPLETO...'
          cd ${{ env.APP_DIR }}
          tar -xzf /tmp/deploy.tar.gz
          rm -f /tmp/deploy.tar.gz
          
          # Garantir que nÃ£o hÃ¡ cache
          echo 'ğŸ§¹ Limpando qualquer cache...'
          rm -rf node_modules dist build .next .vite || true
          
          # Limpar cache do Docker System
          echo 'ğŸ§¹ Limpando cache do Docker...'
          docker system prune -f || true
          docker builder prune -f || true
          
          echo 'ğŸ—ï¸  BUILD COMPLETO da imagem Docker...'
          docker build --no-cache --pull -t ${{ env.IMAGE_NAME }}:latest .
          
          echo 'ğŸš€ Iniciando aplicaÃ§Ã£o...'
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p ${{ env.PORT }}:80 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            -e APP_NAME='Moria PeÃ§as e ServiÃ§os' \
            -e CLIENT_NAME='Moria - PeÃ§as e ServiÃ§os Automotivos' \
            ${{ env.IMAGE_NAME }}:latest
          
          echo 'â³ Aguardando inicializaÃ§Ã£o (30s)...'
          sleep 30
          
          echo 'ğŸ” Verificando container...'
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo 'âœ… Container rodando!'
            docker ps | grep ${{ env.CONTAINER_NAME }}
          else
            echo 'âŒ Container falhou!'
            docker logs ${{ env.CONTAINER_NAME }} --tail 20
            exit 1
          fi
          
          echo 'ğŸ” Testando aplicaÃ§Ã£o...'
          for i in {1..5}; do
            if curl -f -s http://localhost:${{ env.PORT }}/ >/dev/null 2>&1; then
              echo 'âœ… AplicaÃ§Ã£o funcionando!'
              break
            fi
            echo \"Tentativa \$i/5 - aguardando 10s...\"
            sleep 10
          done
          
          # VerificaÃ§Ã£o final
          if curl -f -s http://localhost:${{ env.PORT }}/ >/dev/null 2>&1; then
            echo 'âœ… Deploy COMPLETO concluÃ­do com sucesso!'
            echo 'ğŸ“‹ Verificando arquivos atualizados...'
            echo 'ğŸ“ Arquivos principais:'
            ls -la ${{ env.APP_DIR }}/src/pages/admin/ | grep -E '(AdminQuotes|AdminOrders)' || echo 'Arquivos nÃ£o encontrados'
            echo 'ğŸ“… Ãšltima modificaÃ§Ã£o do build:'
            docker exec ${{ env.CONTAINER_NAME }} ls -la /usr/share/nginx/html/assets/ | head -5
          else
            echo 'âŒ AplicaÃ§Ã£o nÃ£o respondeu apÃ³s 5 tentativas'
            docker logs ${{ env.CONTAINER_NAME }} --tail 10
            exit 1
          fi
          
          echo 'âœ… DEPLOY COMPLETO CONCLUÃDO!'
          echo 'ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.PORT }}'
          echo 'ğŸ“Š Admin (com OrÃ§amentos): http://${{ env.VPS_HOST }}:${{ env.PORT }}/admin/quotes'
        "

    - name: ğŸ‰ Sucesso
      run: |
        echo "ğŸ”§ MORIA PEÃ‡AS E SERVIÃ‡OS DEPLOYADO COM SUCESSO!"
        echo "ğŸ”¥ REBUILD COMPLETO EXECUTADO - TODOS OS ARQUIVOS ATUALIZADOS"
        echo ""
        echo "ğŸ”— LINKS:"
        echo "ğŸŒ App: http://${{ env.VPS_HOST }}:${{ env.PORT }}"
        echo "ğŸ”§ PeÃ§as: http://${{ env.VPS_HOST }}:${{ env.PORT }}/pecas"
        echo "ğŸ› ï¸ ServiÃ§os: http://${{ env.VPS_HOST }}:${{ env.PORT }}/servicos"
        echo "ğŸ“Š Admin: http://${{ env.VPS_HOST }}:${{ env.PORT }}/admin"