name: ğŸš€ Deploy Moria PeÃ§as & ServiÃ§os - Frontend Supabase

concurrency:
  group: moria-deploy-frontend
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/root/moria-pecas-servicos'
  PORT: '3018'
  IMAGE_NAME: 'moria-frontend-supabase'
  CONTAINER_NAME: 'moria-app'

jobs:
  deploy:
    name: ğŸš€ Deploy Frontend Supabase para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”‘ Setup SSH Tools
      run: |
        echo "ğŸ”‘ Instalando ferramentas SSH..."
        sudo apt-get update -q
        sudo apt-get install -y sshpass
        echo "âœ… Ferramentas SSH instaladas"

    - name: ğŸ” Pre-Deploy Validation
      run: |
        echo "ğŸ” Validando estrutura do projeto..."
        echo "ğŸ“‹ Arquivos essenciais:"
        ls -la package.json vite.config.ts Dockerfile .env.example || echo "âš ï¸ Alguns arquivos faltando"
        echo "ğŸ“‹ Estrutura src/:"
        ls -la src/config/supabase.ts src/services/supabaseApi.ts || echo "âš ï¸ Arquivos Supabase faltando"
        echo "ğŸ“‹ PainÃ©is preservados:"
        ls -la src/pages/StorePanel.tsx src/pages/CustomerPanel.tsx || echo "âš ï¸ PainÃ©is nÃ£o encontrados"

    - name: ğŸ“¦ Prepare Deployment Package
      run: |
        echo "ğŸ“¦ Preparando pacote de deploy..."
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        
        # Criar arquivo compacto (sem node_modules, dist, etc.)
        tar --warning=no-file-changed -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='dist' \
          --exclude='build' \
          --exclude='*.log' \
          --exclude='coverage' \
          --exclude='.env.local' \
          --exclude='backup_before_supabase' \
          . || true
        
        echo "ğŸ“Š Tamanho do pacote:"
        ls -lh deploy.tar.gz

    - name: ğŸ“¤ Upload to VPS
      run: |
        echo "ğŸ“¤ Enviando para VPS..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null deploy.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

    - name: ğŸš€ Deploy on VPS
      run: |
        echo "ğŸ—ï¸ Executando deploy na VPS..."
        echo "ğŸ“‹ InformaÃ§Ãµes do deploy:"
        echo "  ğŸ“¦ Commit: ${{ github.sha }}"
        echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "  ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "  ğŸ• Timestamp: $(date)"
        
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          set -e
          
          echo 'ğŸš€ Iniciando deploy do Frontend Supabase'
          
          # Parar e remover container anterior
          echo 'â¹ï¸ Parando container anterior...'
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rmi ${{ env.IMAGE_NAME }}:latest 2>/dev/null || true
          
          # Verificar e instalar Docker se necessÃ¡rio
          echo 'ğŸ³ Verificando Docker...'
          if ! command -v docker &> /dev/null; then
            echo 'ğŸ“¦ Docker nÃ£o encontrado, instalando...'
            apt-get update -q
            apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update -q
            apt-get install -y docker-ce docker-ce-cli containerd.io
            systemctl start docker
            systemctl enable docker
            echo 'âœ… Docker instalado com sucesso!'
          else
            echo 'âœ… Docker jÃ¡ instalado!'
          fi
          
          # Backup do diretÃ³rio anterior (seguranÃ§a)
          if [ -d '${{ env.APP_DIR }}' ]; then
            echo 'ğŸ’¾ Fazendo backup do deploy anterior...'
            mv '${{ env.APP_DIR }}' '${{ env.APP_DIR }}.backup.\$(date +%Y%m%d-%H%M%S)' 2>/dev/null || true
          fi
          
          # Criar diretÃ³rio e extrair cÃ³digo
          echo 'ğŸ“ Criando diretÃ³rio e extraindo cÃ³digo...'
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          tar -xzf /tmp/deploy.tar.gz
          rm -f /tmp/deploy.tar.gz
          
          # Validar estrutura apÃ³s extraÃ§Ã£o
          echo 'ğŸ” Validando estrutura extraÃ­da...'
          ls -la package.json Dockerfile src/ || echo 'âŒ ERRO: Estrutura invÃ¡lida!'
          echo 'ğŸ“‹ Arquivos Supabase:'
          ls -la src/config/supabase.ts src/services/supabaseApi.ts || echo 'âš ï¸ Arquivos Supabase nÃ£o encontrados'
          
          # Limpar cache do Docker com timeout e controle de erro
          echo 'ğŸ§¹ Limpando cache do Docker (com timeout)...'
          timeout 30 docker system prune -f >/dev/null 2>&1 || echo 'âš ï¸ Limpeza de cache completada (ou timeout)'
          timeout 20 docker builder prune -f >/dev/null 2>&1 || echo 'âš ï¸ Limpeza do builder completada (ou timeout)'
          
          # Build da imagem Docker com verificaÃ§Ã£o de sucesso
          echo 'ğŸ—ï¸ Construindo imagem Docker otimizada...'
          if ! DOCKER_BUILDKIT=1 docker build --no-cache --pull -t ${{ env.IMAGE_NAME }}:latest \
              --build-arg VITE_SUPABASE_URL="http://82.25.69.57:8102" \
              --build-arg VITE_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlLWluc3RhbmNlLW1hbmFnZXIiLCJpYXQiOjE3NTQ5MjAzNjgsImV4cCI6MTc4NjQ1NjM2OH0.lrqlo8hPKPw_DE6Zkl173EDYSj0Jg4qaJcE0xWk7R8Q" \
              . 2>&1; then
            echo 'âŒ ERRO: Build da imagem Docker falhou!'
            echo 'ğŸ” Verificando Dockerfile:'
            ls -la Dockerfile || echo 'âŒ Dockerfile nÃ£o encontrado!'
            exit 1
          fi
          
          # Verificar se a imagem foi criada
          echo 'ğŸ” Verificando se imagem foi criada...'
          if docker images | grep -q "${{ env.IMAGE_NAME }}"; then
            echo 'âœ… Imagem Docker criada com sucesso!'
            docker images | grep "${{ env.IMAGE_NAME }}"
          else
            echo 'âŒ ERRO: Imagem Docker nÃ£o foi criada!'
            exit 1
          fi
          
          # Iniciar container
          echo 'ğŸš€ Iniciando container...'
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p ${{ env.PORT }}:80 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            ${{ env.IMAGE_NAME }}:latest
          
          # Aguardar inicializaÃ§Ã£o
          echo 'â³ Aguardando inicializaÃ§Ã£o (20s)...'
          sleep 20
          
          # Verificar container
          echo 'ğŸ” Verificando container...'
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo 'âœ… Container rodando!'
            docker ps | grep ${{ env.CONTAINER_NAME }}
          else
            echo 'âŒ Container falhou!'
            docker logs ${{ env.CONTAINER_NAME }} --tail 20
            exit 1
          fi
          
          # Testar aplicaÃ§Ã£o
          echo 'ğŸ” Testando aplicaÃ§Ã£o...'
          for i in {1..5}; do
            if curl -f -s http://localhost:${{ env.PORT }}/health >/dev/null 2>&1; then
              echo 'âœ… Health check passou!'
              break
            fi
            echo \"Tentativa \$i/5 - aguardando 8s...\"
            sleep 8
          done
          
          # VerificaÃ§Ã£o final
          if curl -f -s http://localhost:${{ env.PORT }}/ >/dev/null 2>&1; then
            echo 'âœ… Deploy Frontend Supabase concluÃ­do com sucesso!'
            echo 'ğŸ“‹ Verificando estrutura final...'
            docker exec ${{ env.CONTAINER_NAME }} ls -la /usr/share/nginx/html/ | head -10
            echo 'ğŸ” Testando rotas principais:'
            curl -s -o /dev/null -w 'PÃ¡gina PÃºblica: %{http_code} ' http://localhost:${{ env.PORT }}/ && echo ''
            curl -s -o /dev/null -w 'Painel Lojista: %{http_code} ' http://localhost:${{ env.PORT }}/store-panel && echo ''
            curl -s -o /dev/null -w 'Painel Cliente: %{http_code} ' http://localhost:${{ env.PORT }}/customer && echo 'âœ…'
          else
            echo 'âŒ AplicaÃ§Ã£o nÃ£o respondeu apÃ³s tentativas'
            docker logs ${{ env.CONTAINER_NAME }} --tail 15
            exit 1
          fi
          
          echo 'âœ… DEPLOY FRONTEND SUPABASE CONCLUÃDO!'
          echo 'ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.PORT }}'
          echo 'ğŸª Painel Lojista: http://${{ env.VPS_HOST }}:${{ env.PORT }}/store-panel'
          echo 'ğŸ‘¤ Painel Cliente: http://${{ env.VPS_HOST }}:${{ env.PORT }}/customer'
        "

    - name: ğŸ‰ Deploy Success
      run: |
        echo "ğŸ‰ MORIA PEÃ‡AS & SERVIÃ‡OS DEPLOYADO COM SUCESSO!"
        echo "âœ… Frontend Supabase em produÃ§Ã£o"
        echo ""
        echo "ğŸ”— LINKS FUNCIONAIS:"
        echo "ğŸŒ App Principal: http://${{ env.VPS_HOST }}:${{ env.PORT }}"
        echo "ğŸª Painel Lojista: http://${{ env.VPS_HOST }}:${{ env.PORT }}/store-panel"
        echo "ğŸ‘¤ Painel Cliente: http://${{ env.VPS_HOST }}:${{ env.PORT }}/customer"
        echo ""
        echo "âœ… Recursos disponÃ­veis:"
        echo "  ğŸ“¦ CatÃ¡logo de produtos e serviÃ§os"
        echo "  ğŸ›’ Sistema de carrinho e checkout"
        echo "  ğŸª CRUD completo no painel lojista"
        echo "  ğŸ‘¤ Perfil e pedidos no painel cliente"
        echo "  ğŸš€ Powered by Supabase + PostgreSQL"