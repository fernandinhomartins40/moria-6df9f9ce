name: ðŸš€ Deploy Incremental - Preserva Dados

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo do deploy incremental'
        required: false
        default: 'AtualizaÃ§Ã£o de cÃ³digo'

jobs:
  deploy-incremental:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ—ï¸ Build frontend
        run: npm run build

      - name: ðŸ“‹ Criar pacote de atualizaÃ§Ã£o
        run: |
          # Criar diretÃ³rio temporÃ¡rio para o update
          mkdir -p update-package
          
          # Copiar apenas arquivos necessÃ¡rios (SEM banco de dados)
          cp -r dist/ update-package/
          cp -r backend/src/ update-package/backend-src/
          cp -r backend/prisma/ update-package/backend-prisma/
          cp backend/package.json update-package/
          
          # Copiar arquivos opcionais apenas se existirem
          [ -f docker-entrypoint.sh ] && cp docker-entrypoint.sh update-package/ || echo "âš ï¸ docker-entrypoint.sh nÃ£o encontrado"
          [ -f Dockerfile ] && cp Dockerfile update-package/ || echo "âš ï¸ Dockerfile nÃ£o encontrado"
          
          # Criar arquivo de versÃ£o
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > update-package/version.txt
          echo "COMMIT_SHA=${{ github.sha }}" >> update-package/version.txt
          echo "REASON=${{ github.event.inputs.reason }}" >> update-package/version.txt
          
          # Comprimir pacote
          tar -czf moria-update.tar.gz -C update-package .

      - name: ðŸšš Transferir arquivos via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          source: "./moria-update.tar.gz"
          target: "/tmp/"

      - name: ðŸšš Deploy para VPS (Incremental)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            
            echo "ðŸ”„ Iniciando deploy incremental..."
            
            # Definir variÃ¡veis
            PROJECT_DIR="/root/moria-pecas-servicos"
            BACKUP_DIR="/root/backups/moria"
            UPDATE_DIR="/tmp/moria-update"
            
            # Criar diretÃ³rio de backup se nÃ£o existir
            mkdir -p $BACKUP_DIR
            
            # 1. BACKUP DO BANCO ATUAL
            echo "ðŸ’¾ Fazendo backup do banco de dados..."
            if [ -f "$PROJECT_DIR/backend/prisma/database.db" ]; then
              cp "$PROJECT_DIR/backend/prisma/database.db" "$BACKUP_DIR/database-$(date +%Y%m%d-%H%M%S).db"
              echo "âœ… Backup do banco salvo em $BACKUP_DIR"
            else
              echo "âš ï¸  Banco de dados nÃ£o encontrado - primeiro deploy?"
            fi
            
            # 2. PARAR CONTAINER ATUAL
            echo "ðŸ›‘ Parando container atual..."
            docker stop moria-app || true
            docker rm moria-app || true
            
            # 3. EXTRAIR NOVA VERSÃƒO
            echo "ðŸ“¥ Extraindo nova versÃ£o..."
            rm -rf $UPDATE_DIR
            mkdir -p $UPDATE_DIR
            
            # Usar arquivo transferido via SCP
            cd /tmp
            if [ -f "moria-update.tar.gz" ]; then
              echo "âœ… Arquivo encontrado, extraindo..."
              tar -xzf moria-update.tar.gz -C $UPDATE_DIR --strip-components=1
              rm moria-update.tar.gz
              echo "âœ… ExtraÃ§Ã£o concluÃ­da"
            else
              echo "âŒ Arquivo nÃ£o encontrado - falha na transferÃªncia"
              exit 1
            fi
            
            # 4. PRESERVAR BANCO DE DADOS
            echo "ðŸ”’ Preservando banco de dados..."
            if [ -f "$PROJECT_DIR/backend/prisma/database.db" ]; then
              # Salvar banco atual
              cp "$PROJECT_DIR/backend/prisma/database.db" "/tmp/database-preserve.db"
              echo "âœ… Banco preservado temporariamente"
            fi
            
            # 5. ATUALIZAR CÃ“DIGO
            echo "ðŸ”„ Atualizando cÃ³digo..."
            rm -rf $PROJECT_DIR
            mv $UPDATE_DIR $PROJECT_DIR
            
            # 6. RESTAURAR BANCO DE DADOS
            echo "ðŸ”™ Restaurando banco de dados..."
            if [ -f "/tmp/database-preserve.db" ]; then
              mkdir -p "$PROJECT_DIR/backend/prisma"
              mv "/tmp/database-preserve.db" "$PROJECT_DIR/backend/prisma/database.db"
              echo "âœ… Banco de dados restaurado"
            fi
            
            # 7. INSTALAR DEPENDÃŠNCIAS DO BACKEND
            echo "ðŸ“¦ Instalando dependÃªncias do backend..."
            cd $PROJECT_DIR/backend
            npm install --production
            
            # 8. GERAR CLIENTE PRISMA (sem migration)
            echo "ðŸ”§ Regenerando cliente Prisma..."
            npx prisma generate
            
            # 9. REBUILD CONTAINER
            echo "ðŸ—ï¸ Reconstruindo container..."
            cd $PROJECT_DIR
            docker build -t moria-pecas-servicos:latest .
            
            # 10. REINICIAR CONTAINER
            echo "ðŸš€ Iniciando novo container..."
            docker run -d \
              --name moria-app \
              --restart unless-stopped \
              -p 3018:80 \
              -v $PROJECT_DIR/backend/prisma:/app/backend/prisma \
              moria-pecas-servicos:latest
            
            # 11. AGUARDAR INICIALIZAÃ‡ÃƒO
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 10
            
            # 12. VERIFICAR SAÃšDE
            echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
            if curl -f http://localhost:3018/api/health > /dev/null 2>&1; then
              echo "âœ… Deploy incremental concluÃ­do com sucesso!"
              echo "ðŸ“Š Verificando dados preservados..."
              
              # Verificar se dados foram preservados
              PRODUCTS=$(curl -s http://localhost:3018/api/products | jq -r '.total // 0')
              SERVICES=$(curl -s http://localhost:3018/api/services | jq -r '.total // 0')  
              PROMOTIONS=$(curl -s http://localhost:3018/api/promotions | jq -r '.total // 0')
              
              echo "ðŸ“ˆ Status dos dados:"
              echo "   â€¢ Produtos: $PRODUCTS"
              echo "   â€¢ ServiÃ§os: $SERVICES" 
              echo "   â€¢ PromoÃ§Ãµes: $PROMOTIONS"
              
              if [ "$PRODUCTS" -gt 0 ] || [ "$SERVICES" -gt 0 ]; then
                echo "ðŸŽ‰ Dados preservados com sucesso!"
              else
                echo "âš ï¸  AtenÃ§Ã£o: PossÃ­vel perda de dados - verificar backup"
              fi
            else
              echo "âŒ Falha no deploy - aplicaÃ§Ã£o nÃ£o estÃ¡ respondendo"
              exit 1
            fi
            
            # 13. LIMPEZA
            echo "ðŸ§¹ Limpeza de arquivos temporÃ¡rios..."
            rm -rf /tmp/moria-update
            docker system prune -f --volumes=false
            
            echo "âœ¨ Deploy incremental finalizado!"
            echo "ðŸ”— AplicaÃ§Ã£o disponÃ­vel em: http://31.97.85.98:3018"

      - name: ðŸ“ˆ RelatÃ³rio do Deploy
        if: always()
        run: |
          echo "## ðŸ“‹ RelatÃ³rio do Deploy Incremental" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Motivo:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ• Data:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… CaracterÃ­sticas do Deploy Incremental:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¾ **Banco de dados preservado** (backup automÃ¡tico)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ **Apenas cÃ³digo atualizado**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Dados existentes mantidos**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **Zero downtime** (mÃ­nimo possÃ­vel)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”™ **Backup automÃ¡tico** antes da atualizaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY