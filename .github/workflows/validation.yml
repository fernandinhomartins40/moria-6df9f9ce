# .github/workflows/validation.yml - Workflow de validaÃ§Ã£o automÃ¡tica

name: ValidaÃ§Ã£o AutomÃ¡tica do Sistema

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executar validaÃ§Ã£o diÃ¡ria Ã s 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  validate-types:
    name: ValidaÃ§Ã£o de Tipos
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Sincronizar tipos
      run: |
        node scripts/sync-types.js

    - name: Verificar mudanÃ§as nos tipos
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ Tipos desatualizados encontrados!"
          git diff
          exit 1
        else
          echo "âœ… Tipos estÃ£o sincronizados"
        fi

  validate-schemas:
    name: ValidaÃ§Ã£o de Schemas
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Verificar tipos TypeScript
      run: npx tsc --noEmit

    - name: Validar schemas Zod
      run: |
        echo "Validando schemas Zod..."
        node -e "
          try {
            const schemas = require('./src/schemas/index.ts');
            console.log('âœ… Schemas carregados com sucesso');
          } catch (error) {
            console.error('âŒ Erro ao carregar schemas:', error.message);
            process.exit(1);
          }
        "

  validate-system:
    name: ValidaÃ§Ã£o Completa do Sistema
    runs-on: ubuntu-latest
    needs: [validate-types, validate-schemas]

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Executar validaÃ§Ã£o completa
      run: node scripts/validate-system.js

    - name: Upload relatÃ³rio de validaÃ§Ã£o
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: validation-report
        path: validation-report.json
        retention-days: 30

  lint-and-format:
    name: Lint e FormataÃ§Ã£o
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Executar ESLint
      run: npm run lint
      continue-on-error: true

    - name: Verificar formataÃ§Ã£o Prettier
      run: npx prettier --check "src/**/*.{ts,tsx,js,jsx}"
      continue-on-error: true

  security-scan:
    name: VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Audit de seguranÃ§a
      run: npm audit --audit-level=moderate

    - name: Verificar vulnerabilidades conhecidas
      run: |
        echo "Verificando vulnerabilidades conhecidas..."
        if npm audit --json | jq -r '.vulnerabilities | length' | grep -v '^0$'; then
          echo "âŒ Vulnerabilidades encontradas!"
          npm audit --json | jq -r '.vulnerabilities'
        else
          echo "âœ… Nenhuma vulnerabilidade encontrada"
        fi

  performance-check:
    name: VerificaÃ§Ã£o de Performance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Build do projeto
      run: npm run build

    - name: AnÃ¡lise de bundle
      run: |
        echo "Analisando tamanho do bundle..."
        ls -la dist/

        # Verificar se hÃ¡ arquivos muito grandes
        find dist -name "*.js" -size +1M -exec echo "âŒ Arquivo grande encontrado: {} $(stat -f%z {})" \;

    - name: Upload artifacts de build
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  notification:
    name: NotificaÃ§Ã£o de Resultados
    runs-on: ubuntu-latest
    needs: [validate-system, lint-and-format, security-scan, performance-check]
    if: always()

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Download relatÃ³rio de validaÃ§Ã£o
      uses: actions/download-artifact@v3
      with:
        name: validation-report

    - name: Processar resultados
      run: |
        echo "ðŸ“Š Resumo da ValidaÃ§Ã£o:"

        if [ -f validation-report.json ]; then
          SCORE=$(jq -r '.summary.score' validation-report.json)
          PASSED=$(jq -r '.summary.passed' validation-report.json)
          ERRORS=$(jq -r '.summary.totalErrors' validation-report.json)
          WARNINGS=$(jq -r '.summary.totalWarnings' validation-report.json)

          echo "Score: $SCORE%"
          echo "Status: $([ "$PASSED" = "true" ] && echo "âœ… APROVADO" || echo "âŒ REPROVADO")"
          echo "Erros: $ERRORS"
          echo "Avisos: $WARNINGS"

          # Criar summary para GitHub
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ“‹ RelatÃ³rio de ValidaÃ§Ã£o

        | MÃ©trica | Valor |
        |---------|-------|
        | **Score** | $SCORE% |
        | **Status** | $([ "$PASSED" = "true" ] && echo "âœ… APROVADO" || echo "âŒ REPROVADO") |
        | **Erros** | $ERRORS |
        | **Avisos** | $WARNINGS |

        ### Detalhes
        $(jq -r '.results | to_entries[] | "- **\(.key)**: \(if .value.passed then "âœ… OK" else "âŒ FALHOU" end)"' validation-report.json)
        EOF

          # Falhar se score < 80%
          if [ "$SCORE" -lt 80 ]; then
            echo "âŒ Score muito baixo: $SCORE%"
            exit 1
          fi
        else
          echo "âŒ RelatÃ³rio de validaÃ§Ã£o nÃ£o encontrado"
          exit 1
        fi

  auto-fix:
    name: CorreÃ§Ã£o AutomÃ¡tica
    runs-on: ubuntu-latest
    needs: [validate-system]
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependÃªncias
      run: npm ci

    - name: Executar correÃ§Ãµes automÃ¡ticas
      run: |
        echo "ðŸ”§ Executando correÃ§Ãµes automÃ¡ticas..."

        # Sincronizar tipos
        node scripts/sync-types.js

        # Formatar cÃ³digo
        npx prettier --write "src/**/*.{ts,tsx,js,jsx}"

        # Fix ESLint
        npm run lint -- --fix || true

    - name: Commit correÃ§Ãµes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ðŸ¤– CorreÃ§Ãµes automÃ¡ticas de validaÃ§Ã£o

          - SincronizaÃ§Ã£o de tipos
          - FormataÃ§Ã£o de cÃ³digo
          - CorreÃ§Ãµes de lint

          [skip ci]"
          git push
          echo "âœ… CorreÃ§Ãµes aplicadas e commitadas"
        else
          echo "â„¹ï¸ Nenhuma correÃ§Ã£o necessÃ¡ria"
        fi