name: Deploy Moria to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          # Instalar sshpass para autentica√ß√£o com senha
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          # Criar diret√≥rio no VPS
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "mkdir -p /root/moria"

          # Verificar estrutura do projeto antes do rsync
          echo "=== Verificando estrutura localmente antes do rsync ==="
          ls -la apps/backend/src/modules/ | head -20
          ls -la apps/backend/src/middleware/ || echo "‚ö†Ô∏è middleware n√£o encontrado"

          # Sincronizar c√≥digo via rsync
          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            --exclude='apps/backend/uploads' \
            --exclude='.env' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@moriapecas.com.br:/root/moria/

          # Verificar se c√≥digo foi copiado
          echo "=== Verificando estrutura na VPS ap√≥s rsync ==="
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "ls -la /root/moria/apps/backend/src/modules/ | head -20"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: moriapecas.com.br
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 300s
          script: |
            set -e

            echo "=== Iniciando Deploy Moria Pe√ßas ==="

            # Diret√≥rio da aplica√ß√£o
            APP_DIR="/root/moria"
            cd $APP_DIR

            # ===== VERIFICA√á√ÉO PR√â-DEPLOY =====
            echo "=== Executando verifica√ß√£o pr√©-deploy ==="
            if [ -f "scripts/pre-deploy-check.sh" ]; then
              chmod +x scripts/pre-deploy-check.sh
              if bash scripts/pre-deploy-check.sh; then
                echo "‚úÖ Verifica√ß√£o pr√©-deploy passou"
              else
                echo "‚ùå Verifica√ß√£o pr√©-deploy falhou!"
                echo "‚ö†Ô∏è Continuando deploy (avisos n√£o bloqueiam)"
              fi
            else
              echo "‚ö†Ô∏è Script pre-deploy-check.sh n√£o encontrado, pulando verifica√ß√£o"
            fi
            echo ""

            # ===== BACKUP PR√â-DEPLOY =====
            echo "=== Criando backup pr√©-deploy ==="
            if [ -f "scripts/auto-backup-uploads.sh" ]; then
              chmod +x scripts/auto-backup-uploads.sh
              if bash scripts/auto-backup-uploads.sh; then
                echo "‚úÖ Backup pr√©-deploy criado com sucesso"
              else
                echo "‚ö†Ô∏è Backup pr√©-deploy falhou, mas continuando deploy"
              fi
            else
              echo "‚ö†Ô∏è Script auto-backup-uploads.sh n√£o encontrado, pulando backup"
            fi
            echo ""

            # Parar containers existentes (SEM -v para preservar volumes)
            echo "Parando containers existentes..."
            docker-compose -f docker-compose.vps.yml down || true

            # Verificar e garantir que volumes cr√≠ticos existam
            echo "=== Verificando volumes Docker ==="
            if ! docker volume ls | grep -q "moria.*uploads_data"; then
              echo "‚ö†Ô∏è Volume uploads_data n√£o existe, ser√° criado no pr√≥ximo docker-compose up"
            else
              echo "‚úì Volume uploads_data encontrado"
              docker volume inspect $(docker volume ls --format '{{.Name}}' | grep "moria.*uploads_data") | grep Mountpoint || true
            fi

            if ! docker volume ls | grep -q "moria.*postgres_data"; then
              echo "‚ö†Ô∏è Volume postgres_data n√£o existe, ser√° criado no pr√≥ximo docker-compose up"
            else
              echo "‚úì Volume postgres_data encontrado"
            fi

            echo "Verificando c√≥digo sincronizado..."
            ls -la

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << 'EOF'
            # Node.js
            NODE_ENV=production

            # Application
            PORT=3001

            # PostgreSQL
            POSTGRES_USER=moria
            POSTGRES_PASSWORD=moria2024secure
            POSTGRES_DB=moria

            # Database URL (PostgreSQL)
            DATABASE_URL=postgresql://moria:moria2024secure@postgres:5432/moria

            # JWT
            JWT_SECRET=moria-production-secret-$(date +%s)-$(openssl rand -hex 16)
            JWT_EXPIRES_IN=7d
            JWT_ADMIN_EXPIRES_IN=8h

            # CORS
            FRONTEND_URL=https://www.moriapecas.com.br
            CORS_ORIGIN=https://www.moriapecas.com.br,http://www.moriapecas.com.br,https://moriapecas.com.br,http://moriapecas.com.br,http://72.60.10.108:3090,http://localhost:3090

            # Logs
            LOG_LEVEL=info

            # Seed
            RUN_SEED=true
            EOF

            # Adicionar BUILD_TIMESTAMP ao .env
            echo "BUILD_TIMESTAMP=$(date +%s)" >> .env

            # Limpar containers e imagens antigas (PRESERVAR volumes do PostgreSQL)
            echo "Limpando recursos antigos..."
            docker container prune -f || true
            docker image prune -af || true

            # Garantir BUILD_TIMESTAMP como vari√°vel de ambiente ANTES do build
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # ===== VALIDA√á√ÉO PR√â-BUILD: Verificar estrutura do projeto =====
            echo "=== Validando estrutura do projeto antes do build ==="

            if [ ! -f "apps/backend/src/server.ts" ]; then
              echo "‚ùå ERRO: server.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì server.ts encontrado"

            if [ ! -f "apps/backend/src/app.ts" ]; then
              echo "‚ùå ERRO: app.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì app.ts encontrado"

            if [ ! -f "apps/backend/prisma/schema.prisma" ]; then
              echo "‚ùå ERRO: schema.prisma n√£o encontrado!"
              exit 1
            fi
            echo "‚úì schema.prisma encontrado"

            if [ ! -d "apps/frontend/src" ]; then
              echo "‚ùå ERRO: diret√≥rio frontend/src n√£o encontrado!"
              exit 1
            fi
            echo "‚úì Estrutura frontend encontrada"

            # Validar m√≥dulos cr√≠ticos
            if [ ! -f "apps/backend/src/modules/products/products.routes.ts" ]; then
              echo "‚ùå ERRO: products.routes.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì products module encontrado"

            if [ ! -f "apps/backend/src/modules/auth/auth.routes.ts" ]; then
              echo "‚ùå ERRO: auth.routes.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì auth module encontrado"

            if [ ! -f "apps/backend/src/modules/orders/orders.routes.ts" ]; then
              echo "‚ùå ERRO: orders.routes.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì orders module encontrado"

            if [ ! -f "apps/backend/src/modules/admin/admin.routes.ts" ]; then
              echo "‚ùå ERRO: admin.routes.ts n√£o encontrado!"
              exit 1
            fi
            echo "‚úì admin module encontrado"

            echo "=== Todos os arquivos cr√≠ticos validados ==="

            # Parar e remover containers antigos PRIMEIRO
            # IMPORTANTE: NUNCA usar 'down -v' pois remove volumes e perder√≠amos as imagens!
            echo "Parando e removendo containers antigos (preservando volumes)..."
            docker-compose -f docker-compose.vps.yml down --remove-orphans || true
            docker rm -f moria-vps 2>/dev/null || true
            docker rm -f moria-postgres 2>/dev/null || true

            # Remover imagens antigas do moria para for√ßar rebuild completo
            echo "Removendo imagens antigas do moria..."
            docker rmi moria-vps 2>/dev/null || true
            docker rmi $(docker images -q 'moria*') 2>/dev/null || true

            # ===== BUILD NO HOST (FORA DO DOCKER) =====
            echo "=== Instalando depend√™ncias e fazendo build no host ==="

            # Instalar depend√™ncias do workspace (root)
            cd $APP_DIR
            echo "Instalando depend√™ncias do workspace..."
            npm install || { echo "‚ùå Erro ao instalar depend√™ncias do workspace"; exit 1; }

            # Backend
            cd $APP_DIR/apps/backend
            echo "Instalando depend√™ncias do backend..."
            npm install || { echo "‚ùå Erro ao instalar depend√™ncias do backend"; exit 1; }

            echo "Gerando Prisma client..."
            npx prisma generate || { echo "‚ùå Erro ao gerar Prisma client"; exit 1; }

            # Voltar para root e rodar build completo
            cd $APP_DIR
            echo "=== Executando build completo (Backend + Frontend com PWA) ==="
            npm run build:docker || { echo "‚ùå Erro no build completo"; exit 1; }

            # Verificar se todos os builds foram criados
            echo "=== Validando builds criados ==="

            if [ ! -f "apps/backend/dist/server.js" ]; then
              echo "‚ùå Erro: backend/dist/server.js n√£o foi criado!"
              exit 1
            fi
            echo "‚úÖ Backend compilado"

            if [ ! -f "apps/frontend/dist/index.html" ]; then
              echo "‚ùå Erro: frontend/dist/index.html n√£o foi criado!"
              exit 1
            fi
            echo "‚úÖ Frontend compilado"

            if [ ! -f "apps/frontend/dist/manifest.webmanifest" ]; then
              echo "‚ö†Ô∏è Aviso: PWA manifest n√£o foi gerado!"
            else
              echo "‚úÖ PWA manifest gerado"
            fi

            if [ ! -d "apps/frontend/dist/icons" ]; then
              echo "‚ö†Ô∏è Aviso: √çcones PWA n√£o foram copiados!"
            else
              echo "‚úÖ √çcones PWA copiados"
            fi

            echo "‚úÖ Build completo conclu√≠do com sucesso (Backend + Frontend PWA)"

            # Build da imagem Docker (agora apenas copia os arquivos j√° compilados)
            echo "Construindo imagem Docker..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull || { echo "‚ùå Erro ao construir imagem Docker"; exit 1; }
            echo "‚úÖ Imagem Docker constru√≠da com sucesso"

            # Iniciar container
            echo "Iniciando containers..."
            docker-compose -f docker-compose.vps.yml up -d --remove-orphans || { echo "‚ùå Erro ao iniciar containers"; exit 1; }
            echo "‚úÖ Containers iniciados"

            # Aguardar containers iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 10

            # Verificar status dos containers
            echo "=== Verificando status dos containers ==="
            docker-compose -f docker-compose.vps.yml ps

            # Verificar se containers est√£o rodando
            echo "=== Verificando se containers existem ==="
            if ! docker ps -a | grep -q moria-vps; then
              echo "‚ùå Container moria-vps n√£o foi criado!"
              docker-compose -f docker-compose.vps.yml logs
              exit 1
            fi

            if ! docker ps | grep -q moria-vps; then
              echo "‚ùå Container moria-vps n√£o est√° rodando!"
              echo "=== Logs do container ==="
              docker logs moria-vps --tail=100
              exit 1
            fi
            echo "‚úì Container moria-vps est√° rodando"

            if ! docker ps | grep -q moria-postgres; then
              echo "‚ùå Container moria-postgres n√£o est√° rodando!"
              echo "=== Logs do PostgreSQL ==="
              docker logs moria-postgres --tail=50
              exit 1
            fi
            echo "‚úì Container moria-postgres est√° rodando"

            # Aguardar aplica√ß√£o inicializar completamente
            echo "Aguardando aplica√ß√£o inicializar (40s)..."
            sleep 40

            # ===== APLICAR SCHEMA DO PRISMA =====
            echo "=== Aplicando schema do Prisma ao banco de dados ==="
            docker exec moria-vps sh -c "cd /app/apps/backend && npx prisma db push --accept-data-loss" || {
              echo "‚ùå Erro ao aplicar schema do Prisma"
              docker logs moria-vps --tail=50
              exit 1
            }
            echo "‚úÖ Schema do Prisma aplicado com sucesso"

            # ===== DIAGN√ìSTICO: Verificar se aplica√ß√£o est√° rodando =====
            echo "=== Verificando status no supervisord ==="
            docker exec moria-vps supervisorctl status || echo "‚ö†Ô∏è Supervisord ainda n√£o iniciou"

            echo "=== Logs do backend ==="
            docker exec moria-vps cat /var/log/backend.stdout.log 2>/dev/null || echo "Nenhum log stdout ainda"
            docker exec moria-vps cat /var/log/backend.stderr.log 2>/dev/null || echo "Nenhum log stderr"

            echo "=== Logs do frontend ==="
            docker exec moria-vps cat /var/log/frontend.stdout.log 2>/dev/null || echo "Nenhum log frontend stdout"
            docker exec moria-vps cat /var/log/frontend.stderr.log 2>/dev/null || echo "Nenhum log frontend stderr"

            echo "=== Logs da Aplica√ß√£o (√∫ltimas 100 linhas) ==="
            docker logs moria-vps --tail=100

            # ===== VALIDA√á√ÉO P√ìS-BUILD: Verificar compila√ß√£o =====
            echo "=== Validando compila√ß√£o no container ==="

            # Verificar se o backend foi compilado
            if ! docker exec moria-vps test -f /app/apps/backend/dist/server.js; then
              echo "‚ùå ERRO: Backend n√£o foi compilado no container!"
              echo "=== Listando arquivos em backend/dist ==="
              docker exec moria-vps ls -la /app/apps/backend/dist/ 2>/dev/null || echo "Diret√≥rio n√£o existe"
              docker logs moria-vps --tail=200
              exit 1
            fi
            echo "‚úì Backend compilado no container"

            # Verificar se o frontend foi compilado
            if ! docker exec moria-vps test -f /app/apps/frontend/dist/index.html; then
              echo "‚ùå ERRO: Frontend n√£o foi compilado no container!"
              echo "=== Listando arquivos em frontend/dist ==="
              docker exec moria-vps ls -la /app/apps/frontend/dist/ 2>/dev/null || echo "Diret√≥rio n√£o existe"
              docker logs moria-vps --tail=200
              exit 1
            fi
            echo "‚úì Frontend compilado no container"

            # Aguardar aplica√ß√£o inicializar completamente
            echo "=== Aguardando aplica√ß√£o inicializar 10s ==="
            sleep 10

            # ===== CONFIGURAR NGINX PRIMEIRO =====
            echo "=== Configurando Nginx para portas 80, 443 e 3090 ==="

            # Criar configura√ß√£o do Nginx
            cat > /etc/nginx/sites-available/moriapecas.conf << 'NGINX_EOF'
            # Redirecionar HTTP para HTTPS
            server {
                listen 80;
                listen [::]:80;

                server_name moriapecas.com.br www.moriapecas.com.br;

                return 301 https://$server_name$request_uri;
            }

            # HTTPS - Servidor principal
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;

                server_name moriapecas.com.br www.moriapecas.com.br;

                # SSL - Let's Encrypt
                ssl_certificate /etc/letsencrypt/live/moriapecas.com.br/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/moriapecas.com.br/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

                # Logs
                access_log /var/log/nginx/moriapecas-access.log;
                error_log /var/log/nginx/moriapecas-error.log;

                # Limite de upload
                client_max_body_size 10M;

                # API Backend
                location /api/ {
                    proxy_pass http://127.0.0.1:3090/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:3090/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                # Frontend
                location / {
                    proxy_pass http://127.0.0.1:3090/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINX_EOF

            # Habilitar site
            ln -sf /etc/nginx/sites-available/moriapecas.conf /etc/nginx/sites-enabled/

            # Testar e recarregar Nginx (reload para zero downtime)
            nginx -t && systemctl reload nginx
            echo "‚úÖ Nginx configurado com sucesso nas portas 80, 443 e 3090"

            # Aguardar Nginx iniciar
            sleep 3

            # Verificar se est√° escutando nas portas corretas
            echo ""
            echo "=== Verificando portas em uso ==="
            netstat -tulpn | grep nginx | grep -E ":80 |:443 |:3090 "

            # ===== VERIFICAR HEALTH CHECK =====
            echo "=== Verificando health check ==="
            for i in {1..15}; do
              if curl -f http://localhost:3090/health; then
                echo "‚úÖ Moria est√° rodando na porta 3090!"

                # Validar rota de produtos est√° acess√≠vel
                echo "=== Validando rota /api/products ==="
                if curl -f http://localhost:3090/api/products; then
                  echo "‚úÖ Rota /api/products est√° acess√≠vel!"
                else
                  echo "‚ö†Ô∏è Rota /api/products retornou erro - pode ser normal se n√£o houver produtos"
                fi

                echo ""
                echo "=== Testando frontend porta 3090 ==="
                curl -I http://localhost:3090 | head -5

                echo ""
                echo "=== Testando HTTPS ==="
                curl -Ik https://moriapecas.com.br | head -5

                echo ""
                echo "=== Verificando volume de uploads ==="
                UPLOAD_FILES=$(docker exec moria-vps find /app/apps/backend/uploads/products -type f 2>/dev/null | wc -l || echo "0")
                echo "üìÅ Arquivos em uploads/products: $UPLOAD_FILES"

                if [ "$UPLOAD_FILES" -gt 0 ]; then
                  echo "‚úÖ Volume de uploads cont√©m $UPLOAD_FILES arquivo(s)"
                  echo "Exemplos de arquivos:"
                  docker exec moria-vps ls -lh /app/apps/backend/uploads/products | head -5 || true
                else
                  echo "‚ö†Ô∏è Nenhum arquivo encontrado em uploads/products"
                  echo "Isso √© normal para novo deploy. Imagens ser√£o preservadas ap√≥s upload."
                fi

                echo ""
                echo "‚úÖ Deploy conclu√≠do - aplica√ß√£o est√° rodando!"
                echo "üìç Dom√≠nio: https://moriapecas.com.br"
                echo "üìç IP:Porta: http://72.60.10.108:3090"
                echo "üì¶ Volume uploads_data: PERSISTENTE entre deploys"
                exit 0
              fi
              echo "Tentativa $i/15 falhou, aguardando 10s..."

              # Mostrar logs a cada 3 tentativas
              if [ $((i % 3)) -eq 0 ]; then
                echo "=== Logs recentes ==="
                docker logs moria-vps --tail=30
              fi

              sleep 10
            done

            echo "‚ö†Ô∏è Health check falhou ap√≥s 15 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê Moria Pe√ßas dispon√≠vel em: https://www.moriapecas.com.br"
          echo "üåê Acesso alternativo: http://72.60.10.108:3090"
          echo "üìä Health check: http://72.60.10.108:3090/health"
