name: Deploy Moria to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          # Instalar sshpass para autenticaÃ§Ã£o com senha
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          # Criar diretÃ³rio no VPS
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "mkdir -p /root/moria"

          # Verificar se mÃ³dulos existem antes do rsync
          echo "=== Verificando mÃ³dulos localmente antes do rsync ==="
          ls -la apps/backend/src/modules/uploads/ || echo "âŒ uploads nÃ£o encontrado"
          ls -la apps/backend/src/modules/landing/ || echo "âŒ landing nÃ£o encontrado"
          ls -la apps/backend/src/modules/loyalty/ || echo "âŒ loyalty nÃ£o encontrado"
          ls -la apps/backend/src/modules/shipping/ || echo "âŒ shipping nÃ£o encontrado"

          # Sincronizar cÃ³digo via rsync
          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            --exclude='apps/backend/uploads' \
            --exclude='.env' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@moriapecas.com.br:/root/moria/

          # Verificar se mÃ³dulos foram copiados
          echo "=== Verificando mÃ³dulos na VPS apÃ³s rsync ==="
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "ls -la /root/moria/apps/backend/src/modules/uploads/ || echo 'âŒ uploads nÃ£o copiado'"
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "ls -la /root/moria/apps/backend/src/modules/landing/ || echo 'âŒ landing nÃ£o copiado'"
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "ls -la /root/moria/apps/backend/src/modules/loyalty/ || echo 'âŒ loyalty nÃ£o copiado'"
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@moriapecas.com.br "ls -la /root/moria/apps/backend/src/modules/shipping/ || echo 'âŒ shipping nÃ£o copiado'"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: moriapecas.com.br
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 300s
          script: |
            set -e

            echo "=== Iniciando Deploy Moria PeÃ§as ==="

            # DiretÃ³rio da aplicaÃ§Ã£o
            APP_DIR="/root/moria"

            # Parar containers existentes
            echo "Parando containers existentes..."
            cd $APP_DIR
            docker-compose -f docker-compose.vps.yml down || true

            echo "Verificando cÃ³digo sincronizado..."
            ls -la

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << 'EOF'
            # Node.js
            NODE_ENV=production

            # Application
            PORT=3090

            # PostgreSQL
            POSTGRES_USER=moria
            POSTGRES_PASSWORD=moria2024secure
            POSTGRES_DB=moria

            # Database URL (PostgreSQL)
            DATABASE_URL=postgresql://moria:moria2024secure@postgres:5432/moria

            # JWT
            JWT_SECRET=moria-production-secret-$(date +%s)-$(openssl rand -hex 16)
            JWT_EXPIRES_IN=7d
            JWT_ADMIN_EXPIRES_IN=8h

            # CORS
            FRONTEND_URL=https://www.moriapecas.com.br
            CORS_ORIGIN=https://www.moriapecas.com.br
            ALLOWED_ORIGINS=https://www.moriapecas.com.br,http://www.moriapecas.com.br,https://moriapecas.com.br,http://moriapecas.com.br,http://72.60.10.108:3090,http://localhost:3090

            # Logs
            LOG_LEVEL=info
            EOF

            # Adicionar BUILD_TIMESTAMP ao .env
            echo "BUILD_TIMESTAMP=$(date +%s)" >> .env

            # Limpar containers e imagens antigas (PRESERVAR volumes do PostgreSQL)
            echo "Limpando recursos antigos..."
            docker container prune -f || true
            docker image prune -af || true

            # Garantir BUILD_TIMESTAMP como variÃ¡vel de ambiente ANTES do build
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # ===== VALIDAÃ‡ÃƒO PRÃ‰-BUILD: Verificar estrutura do projeto =====
            echo "=== Validando estrutura do projeto antes do build ==="

            if [ ! -f "apps/backend/src/server.ts" ]; then
              echo "âŒ ERRO: server.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ server.ts encontrado"

            if [ ! -f "apps/backend/src/app.ts" ]; then
              echo "âŒ ERRO: app.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ app.ts encontrado"

            if [ ! -f "apps/backend/prisma/schema.prisma" ]; then
              echo "âŒ ERRO: schema.prisma nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ schema.prisma encontrado"

            if [ ! -d "apps/frontend/src" ]; then
              echo "âŒ ERRO: diretÃ³rio frontend/src nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ Estrutura frontend encontrada"

            # Validar mÃ³dulos crÃ­ticos
            if [ ! -f "apps/backend/src/modules/uploads/uploads.routes.ts" ]; then
              echo "âŒ ERRO: uploads.routes.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ uploads module encontrado"

            if [ ! -f "apps/backend/src/modules/landing/landing.routes.ts" ]; then
              echo "âŒ ERRO: landing.routes.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ landing module encontrado"

            if [ ! -f "apps/backend/src/modules/loyalty/loyalty.routes.ts" ]; then
              echo "âŒ ERRO: loyalty.routes.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ loyalty module encontrado"

            if [ ! -f "apps/backend/src/modules/shipping/shipping.routes.ts" ]; then
              echo "âŒ ERRO: shipping.routes.ts nÃ£o encontrado!"
              exit 1
            fi
            echo "âœ“ shipping module encontrado"

            echo "=== Todos os arquivos crÃ­ticos validados ==="

            # Build da imagem sem cache (BUILD_TIMESTAMP vem do export acima)
            echo "Construindo nova imagem..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull

            # Iniciar container
            echo "Iniciando container..."
            docker-compose -f docker-compose.vps.yml up -d

            # Aguardar PostgreSQL e aplicaÃ§Ã£o iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 30

            # ===== DIAGNÃ“STICO: Verificar se aplicaÃ§Ã£o estÃ¡ rodando =====
            echo "=== Verificando status no supervisord ==="
            docker exec moria-vps supervisorctl status || true

            echo "=== Logs do backend ==="
            docker exec moria-vps cat /var/log/backend.stdout.log || echo "Nenhum log stdout"
            docker exec moria-vps cat /var/log/backend.stderr.log || echo "Nenhum log stderr"

            echo "=== Logs do frontend ==="
            docker exec moria-vps cat /var/log/frontend.stdout.log || echo "Nenhum log frontend stdout"
            docker exec moria-vps cat /var/log/frontend.stderr.log || echo "Nenhum log frontend stderr"

            # Verificar status
            echo "Verificando status dos containers..."
            docker-compose -f docker-compose.vps.yml ps

            # Verificar logs do PostgreSQL
            echo "=== Logs do PostgreSQL ==="
            docker logs moria-postgres --tail=20

            # Verificar logs da aplicaÃ§Ã£o
            echo "=== Logs da AplicaÃ§Ã£o ==="
            docker logs moria-vps --tail=100

            # Verificar se container estÃ¡ rodando
            if ! docker ps | grep -q moria-vps; then
              echo "âŒ Container moria-vps nÃ£o estÃ¡ rodando!"
              echo "=== Logs completos do container ==="
              docker logs moria-vps
              exit 1
            fi

            # ===== VALIDAÃ‡ÃƒO PÃ“S-BUILD: Verificar compilaÃ§Ã£o =====
            echo "=== Validando compilaÃ§Ã£o no container ==="

            # Verificar se o backend foi compilado
            if ! docker exec moria-vps test -f /app/apps/backend/dist/server.js; then
              echo "âŒ ERRO: Backend nÃ£o foi compilado no container!"
              echo "=== Listando arquivos em backend/dist ==="
              docker exec moria-vps ls -la /app/apps/backend/dist/ || true
              exit 1
            fi
            echo "âœ“ Backend compilado no container"

            # Verificar se o frontend foi compilado
            if ! docker exec moria-vps test -f /app/apps/frontend/dist/index.html; then
              echo "âŒ ERRO: Frontend nÃ£o foi compilado no container!"
              echo "=== Listando arquivos em frontend/dist ==="
              docker exec moria-vps ls -la /app/apps/frontend/dist/ || true
              exit 1
            fi
            echo "âœ“ Frontend compilado no container"

            # Aguardar aplicaÃ§Ã£o inicializar completamente
            echo "=== Aguardando aplicaÃ§Ã£o inicializar 10s ==="
            sleep 10

            # ===== CONFIGURAR NGINX PRIMEIRO =====
            echo "=== Configurando Nginx para portas 80, 443 e 3090 ==="

            # Criar configuraÃ§Ã£o do Nginx
            cat > /etc/nginx/sites-available/moriapecas.conf << 'NGINX_EOF'
            # Redirecionar HTTP para HTTPS
            server {
                listen 80;
                listen [::]:80;

                server_name moriapecas.com.br www.moriapecas.com.br;

                return 301 https://$server_name$request_uri;
            }

            # HTTPS - Servidor principal
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;

                server_name moriapecas.com.br www.moriapecas.com.br;

                # SSL - Let's Encrypt
                ssl_certificate /etc/letsencrypt/live/moriapecas.com.br/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/moriapecas.com.br/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

                # Logs
                access_log /var/log/nginx/moriapecas-access.log;
                error_log /var/log/nginx/moriapecas-error.log;

                # Limite de upload
                client_max_body_size 10M;

                # API Backend
                location /api/ {
                    proxy_pass http://127.0.0.1:3091/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:3091/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                # Frontend
                location / {
                    proxy_pass http://127.0.0.1:8080/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }

            # Porta 3090 - Acesso direto por IP
            server {
                listen 3090;
                listen [::]:3090;

                server_name _;

                # Logs
                access_log /var/log/nginx/moriapecas-3090-access.log;
                error_log /var/log/nginx/moriapecas-3090-error.log;

                # Limite de upload
                client_max_body_size 10M;

                # API Backend
                location /api/ {
                    proxy_pass http://127.0.0.1:3091/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:3091/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                # Frontend
                location / {
                    proxy_pass http://127.0.0.1:8080/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINX_EOF

            # Habilitar site
            ln -sf /etc/nginx/sites-available/moriapecas.conf /etc/nginx/sites-enabled/

            # Testar e recarregar Nginx
            nginx -t && systemctl reload nginx
            echo "âœ… Nginx configurado com sucesso nas portas 80, 443 e 3090"

            # Aguardar Nginx iniciar
            sleep 3

            # Verificar se estÃ¡ escutando nas portas corretas
            echo ""
            echo "=== Verificando portas em uso ==="
            netstat -tulpn | grep nginx | grep -E ":80 |:443 |:3090 "

            # ===== VERIFICAR HEALTH CHECK =====
            echo "=== Verificando health check ==="
            for i in {1..15}; do
              if curl -f http://localhost:3090/health; then
                echo "âœ… Moria estÃ¡ rodando na porta 3090!"

                # Validar rota de produtos estÃ¡ acessÃ­vel
                echo "=== Validando rota /api/products ==="
                if curl -f http://localhost:3090/api/products; then
                  echo "âœ… Rota /api/products estÃ¡ acessÃ­vel!"
                else
                  echo "âš ï¸ Rota /api/products retornou erro - pode ser normal se nÃ£o houver produtos"
                fi

                echo ""
                echo "=== Testando frontend porta 3090 ==="
                curl -I http://localhost:3090 | head -5

                echo ""
                echo "=== Testando HTTPS ==="
                curl -Ik https://moriapecas.com.br | head -5

                echo ""
                echo "âœ… Deploy concluÃ­do - aplicaÃ§Ã£o estÃ¡ rodando!"
                echo "ðŸ“ DomÃ­nio: https://moriapecas.com.br"
                echo "ðŸ“ IP:Porta: http://72.60.10.108:3090"
                exit 0
              fi
              echo "Tentativa $i/15 falhou, aguardando 10s..."

              # Mostrar logs a cada 3 tentativas
              if [ $((i % 3)) -eq 0 ]; then
                echo "=== Logs recentes ==="
                docker logs moria-vps --tail=30
              fi

              sleep 10
            done

            echo "âš ï¸ Health check falhou apÃ³s 15 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ Moria PeÃ§as disponÃ­vel em: https://www.moriapecas.com.br"
          echo "ðŸŒ Acesso alternativo: http://72.60.10.108:3090"
          echo "ðŸ“Š Health check: http://72.60.10.108:3090/health"
